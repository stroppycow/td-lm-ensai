---
title: "TD 2 - Exercice 11"
lang: fr
author: "Th√©o Leroy"
date: "17 octobre 2025"
params:
  question_courante: 5
format:
  live-html:
    code-background: true
    toc: true
    page-layout: full
webr:
  render-df: gt-interactive
  resources:
    - ./../data/ozone.txt
  packages:
      - dplyr
      - readr
      - ggplot2
      - cowplot
      - GGally
      - car
      - leaps
      - lmtest
editor: 
  mode: source
  markdown: 
    wrap: 72
fig-align: center
filters: 
  - diagram
  - custom-callout
custom-callout:    
  answer:
    color: "#CCCCCC"
    icon: true
    icon-symbol: "üìù"
    appearance: "default"
    title: "Correction"
---

{{< include ./../_extensions/conditionnal.qmd >}}
{{< include ./../_extensions/r-wasm/live/_knitr.qmd >}}

On consid√®re de nouveau les donn√©es `ozone.txt` √©tudi√©es dans l‚Äôexercice 7. On d√©sire
tirer profit des variables qualitatives pr√©sentes dans le jeu de donn√©es (c‚Äôest √† dire la
pr√©sence ou non de pluie, et la direction principale du vent) pour √©ventuellement am√©liorer
le mod√®le construit dans l‚Äôexercice 7.


## Question 1

On reprend le mod√®le s√©lectionn√© dans l‚Äôexercice 7, soit $\texttt{maxO3}$ en fonction de
$\texttt{T12}$, $\texttt{Ne9}$, $\texttt{Vx9}$ et $\texttt{maxO3v}$ o√π $\texttt{maxO3v}$ repr√©sente la concentration maximale en ozone de la veille (cr√©er cette variable si besoin). Ajuster ce mod√®le sur les donn√©es.

::: {.content-visible when-meta="is_answer_print_1"}

::: answer

On charge les donn√©es du fichier `ozone.txt` en {{< iconify logos:r-lang >}} sous forme de `data.frame`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
data_ozone <- read.csv(
  file = "data/ozone.txt",
  header = TRUE,
  sep = " ",
  quote = '"',
  colClasses = c(
    "character", "character", "numeric", "numeric", "numeric", "numeric", "numeric", 
    "numeric", "numeric", "numeric", "numeric", "numeric", "factor", "factor"
  )
)
data_ozone$date <- as.Date(data_ozone$date, "%Y%m%d")
data_ozone$maxO3v <- c(NA, data_ozone$maxO3[1:(nrow(data_ozone)-1)])
data_ozone
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_ozone <- readr::read_delim(
  file = "data/ozone.txt",
  col_names = c(
    "date","maxO3","T9","T12","T15","Ne9","Ne12","Ne15",
    "Vx9","Vx12","Vx15","vent","pluie"
  ),
  col_types = readr::cols(
    readr::col_skip(),
    readr::col_date(format = "%Y%m%d"),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_number(),
    readr::col_factor(),
    readr::col_factor()
  ),
  skip = 1,
  delim = " ",
  quote = '"'
)  |>
  dplyr::mutate(
    maxO3v = dplyr::lag(maxO3)
  )
data_ozone
```
:::

Le fichier charg√© contient bien 122 observations avec les variables
$\texttt{maxO3}$ pour la concentration maximale d‚Äôozone mesur√©e chaque jour
(exprim√©e en m√®tre), $\texttt{T9}$, $\texttt{T12}$, $\texttt{T15}$ pour les temp√©ratures, $\texttt{Ne9}$,
$\texttt{Ne12}$, $\texttt{Ne15}$ pour les n√©bulosit√©s, $\texttt{Vx9}$, $\texttt{Vx12}$, $\texttt{Vx15}$ pour la
vitesse du vent, $\texttt{vent}$ pour la direction du vent et $\texttt{pluie}$ pour le
niveau de pluie.

On ajoute √©galement la concentration maximale d‚Äôozone mesur√©e la veille
identifi√© comme variable pertinente. Elle est √† la fois explicative et
corrige les probl√®mes d'autocorr√©lation des r√©sidus.

On effectue la r√©gression
$$\texttt{maxO3}_i = \beta_1+\beta_2\texttt{T12}_i+\beta_3\texttt{Ne9}_i+\beta_4\texttt{Vx9}_i+\beta_5\texttt{maxO3v}_i+\varepsilon_i$$
√† l'aide de la fonction `lm` disponible nativement dans
{{< iconify logos:r-lang >}}. On cherche ainsi une estimation du vecteur
$\beta$ √† l'aide de la m√©thode des moindres carr√©s ordinaires (MCO).

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
fit_q1 <- lm(formula = maxO3 ~T12 + Ne9 + Vx9 + maxO3v, data = data_ozone)
summary(fit_q1)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
fit_q1 <- lm(formula = maxO3 ~T12 + Ne9 + Vx9 + maxO3v, data = data_ozone)
summary(fit_q1)
```
:::

:::

:::

## Question 2

Repr√©senter graphiquement $\texttt{maxO3}$ en fonction de la pr√©sence de pluie. Un lien
semble-t-il pr√©sent ? Le confirmer par un test statistique.


::: {.content-visible when-meta="is_answer_print_2"}

::: answer

On peut faire une boite √† moustaches de la variable $\texttt{maxO3}$ selon les
modalit√©s de pluie. On peut √©galement repr√©senter les distributions de
$\texttt{maxO3}$ par groupe (Sec/Pluie) avec des histogrammes.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
# Boxplot
boxplot(
  maxO3 ~ pluie,
  data = data_ozone,
  main = "Distribution de la quantit√© d'ozone selon le niveau de pluie",
  col = c(
    adjustcolor("powderblue", alpha.f = 0.7),
    adjustcolor("pink", alpha.f = 0.7)
    
  )
)

# Histogramme
hist(
  data_ozone[data_ozone$pluie == "Sec", "maxO3"],
  main = "Distribution de la quantit√© d'ozone selon le niveau de pluie",
  xlab = "maxO3",
  ylab = "Fr√©quence",
  col = adjustcolor("pink", alpha.f = 0.7),
  xlim = c(40, 170),
  ylim = c(0, 15)
)
hist(
  data_ozone[data_ozone$pluie == "Pluie", "maxO3"],
  col = adjustcolor("powderblue", alpha.f = 0.7),
  add = TRUE
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
# Boxplot
ggplot2::ggplot(
  data = subset(data_ozone, !is.na(pluie) & !is.na(maxO3)),
  mapping = ggplot2::aes(x = pluie, y = maxO3, fill = pluie)
) +
  ggplot2::geom_boxplot(alpha = 0.7) +
  ggplot2::scale_fill_manual(values = c("Pluie"="powderblue", "Sec"="pink")) +
  ggplot2::labs(
    title = "Distribution de la quantit√© d'ozone selon le niveau de pluie",
    x = "Niveau de pluie",
    y = "Quantit√© d'ozone"
  ) +
  ggplot2::theme_minimal()

# Histogramme
ggplot2::ggplot(
  data = subset(data_ozone, !is.na(pluie) & !is.na(maxO3)),
  mapping = ggplot2::aes(x = maxO3, fill = pluie, colour = pluie)
) +
  ggplot2::geom_histogram(binwidth = 10, alpha = 0.7) +
  ggplot2::scale_fill_manual(values = c("Pluie"="powderblue", "Sec"="pink")) +
  ggplot2::scale_colour_manual(values = c("Pluie"="powderblue", "Sec"="pink")) +
  ggplot2::labs(
    title = "Distribution de la quantit√© d'ozone selon le niveau de pluie",
    x = "maxO3",
    y = "Fr√©quence"
  ) +
  ggplot2::theme_minimal()
```
:::

Graphiquement, on constate un lien. La quantit√© maximale d'ozone sur une
journ√©e ($\texttt{maxO3}$) est moindre lorsque le temps est pluvieux.

Afin de confirmer cette analyse graphique on pourrait effectuer un test
de Student d'√©galit√© des moyennes dans deux groupes (slide 27 du cours)
sous l'hypoth√®se que la distribution de $\texttt{maxO3}$ est gaussienne et de
m√™me variance $\sigma^2$ dans chaque groupe. Toutefois l‚Äô√©galit√© des
variances ici ne semble pas vraiment v√©rifi√©e ici au vu des boxplots. On
peut d'ailleurs tester cette √©galit√© des variances avec le test de
Levene ou le test de Bartlett (slide 146).

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::leveneTest(maxO3 ~ pluie, data = data_ozone)
bartlett.test(maxO3 ~ pluie, data = data_ozone)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
cat("Test de Levene\n")
car::leveneTest(maxO3 ~ pluie, data = data_ozone)
cat("Test de Bartlett\n")
bartlett.test(maxO3 ~ pluie, data = data_ozone)
```
:::

L'hypoth√®se nulle d'√©galit√© des variance est rejet√©e pour ces deux tests
au niveau $\alpha=0.05$ car les p-valeurs sont bien inf√©rieures √†
$\alpha$.

On peut alors effectuer un test de Welch qui est une adapatation du test
de Student lorsque les deux populations ont des variances diff√©rentes.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
t.test(maxO3 ~ pluie, data = data_ozone, var.equal = FALSE)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
t.test(maxO3 ~ pluie, data = data_ozone, var.equal = FALSE)
```
:::

On rejette l'hypoth√®se nulle du test de Welch : les moyennes de la
variable $\texttt{maxO3}$ diff√®rent entre les journ√©es avec et sans pluie.

:::

:::

## Question 3

Ajouter au mod√®le de la premi√®re question la variable $\texttt{pluie}$ de mani√®re la plus
g√©n√©rale possible (i.e. en incluant une interaction avec chaque variable en plus d‚Äôun
effet sur la constante). Tester la significativit√© de ces ajouts en effectuant un test de
Fisher de mod√®les emboit√©s entre ce mod√®le et le mod√®le initial.

::: {.content-visible when-meta="is_answer_print_3"}

::: answer

On ajoute la variable $\texttt{pluie}$ en incluant l'effet sur la constante et
les interactions avec les variables continues initiales ($\texttt{T12}$, $\texttt{Ne9}$,
$\texttt{Vx9}$ et $\texttt{maxO3v}$).

En prenant la modalit√© $\texttt{Pluie}$ comme r√©f√©rence, le mod√®le peut
s'√©crire alors

$$
\begin{align*}
\texttt{maxO3}_i &= 
\beta_1+
\beta_2{\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i \\ &+ 
\beta_3\texttt{T12}_i+
\beta_4{\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i\texttt{T12}_i \\ &+
\beta_5\texttt{Ne9}_i+
\beta_6{\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i\texttt{Ne9}_i \\ &+
\beta_7\texttt{Vx9}_i+
\beta_8{\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i\texttt{Vx9}_i \\ &+
\beta_9\texttt{maxO3v}_i+
\beta_{10}{\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i\texttt{maxO3v}_i \\ &+
\varepsilon_i
\end{align*}
$$

ou de mani√®re √©quivalente

$$
\texttt{maxO3}_i =\begin{cases}
\beta_1+
\beta_3\texttt{T12}_i+
\beta_5\texttt{Ne9}_i+
\beta_7\texttt{Vx9}_i+
\beta_9\texttt{maxO3v}_i+
\varepsilon_i \ \textrm{si} \ {\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i = 0 \\
(\beta_1+\beta_2)+
(\beta_3+\beta_4)\texttt{T12}_i+
(\beta_5+\beta_6)\texttt{Ne9}_i+
(\beta_7+\beta_8)\texttt{Vx9}_i+
(\beta_9+\beta_{10})\texttt{maxO3v}_i+
\varepsilon_i \ \textrm{si} \ {\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i = 1 \\
\end{cases}
$$

On ajuste ce mod√®le avec la fonction `lm` par d√©faut R va consid√©rer la
premi√®re modalit√© (dans l'ordre alphab√©tique) de la variable $\texttt{pluie}$
comme r√©f√©rence pour rendre le mod√®le identifiable (c'est √† dire
`pluie=Pluie` comme nous venons de l'√©crire).

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
fit_q3 <- lm(formula = maxO3 ~ pluie + T12 + T12:pluie + Ne9 + Ne9:pluie + Vx9 + Vx9:pluie + maxO3v + maxO3v:pluie, data = data_ozone)
# Alternative plus concise
# fit_q3 <- lm(formula = (maxO3 ~T12 + Ne9 + Vx9 + maxO3v)*pluie, data = data_ozone)
summary(fit_q3)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
fit_q3 <- lm(formula = maxO3 ~ pluie + T12 + T12*pluie + Ne9 + Ne9*pluie + Vx9 + Vx9*pluie + maxO3v + maxO3v*pluie, data = data_ozone)
# Alternative plus concise
# fit_q3 <- lm(formula = (maxO3 ~T12 + Ne9 + Vx9 + maxO3v)*pluie, data = data_ozone)
summary(fit_q3)
```
:::

On constate qu'il n'y a pas beaucoup de coefficients significatifs. On
peut suspecter des probl√®mes de multicolin√©arit√©.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::vif(fit_q3)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::vif(fit_q3)
```
:::

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(fit_q1, fit_q3)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(fit_q1, fit_q3)
```
:::

La p-value √©lev√©e (0.7367) confirme que l‚Äôon peut accepter les
contraintes, et donc privil√©gier le mod√®le initial sans pluie, ni les
interactions associ√©es.

:::

:::

## Question 4

Tester de m√™me le mod√®le plus simple dans lequel seul un effet additif de la variable
$\texttt{pluie}$ est int√©gr√©, et non ses interactions avec les autres variables. Le r√©sultat est-il
en d√©saccord avec l‚Äôanalyse graphique de la question 2 ? Comment expliquer le r√©sultat ?

::: {.content-visible when-meta="is_answer_print_4"}

::: answer

En prenant la modalit√© $\texttt{Pluie}$ comme r√©f√©rence, le mod√®le peut
s'√©crire alors

$$
\begin{align*}
\texttt{maxO3}_i &= 
\beta_1+
\beta_2{\mathbb{1}_{\texttt{pluie}=\texttt{Sec}}}_i + 
\beta_3\texttt{T12}_i+
\beta_4\texttt{Ne9}_i+
\beta_5\texttt{Vx9}_i+
\beta_6\texttt{maxO3v}_i+
\varepsilon_i
\end{align*}
$$

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
fit_q4 <- lm(formula = maxO3 ~ pluie + T12 + Ne9  + Vx9 +  + maxO3v , data = data_ozone)
summary(fit_q4)
anova(fit_q1, fit_q4)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
fit_q4 <- lm(formula = maxO3 ~ pluie + T12 + Ne9  + Vx9 + maxO3v, data = data_ozone)
summary(fit_q4)
anova(fit_q1, fit_q4)
```
:::

Le r√©sultat du mod√®le montre que le coefficient de la variable pluie
pour la condition "Sec" n'est pas significativement diff√©rent de celui
pour "Pluie" (le coefficient estim√© repr√©sente leur diff√©rence et n'est
pas significatif). De plus, le test de comparaison avec le mod√®le
initial confirme que la variable pluie n‚Äôapporte pas d‚Äôinformation
utile. Ce constat peut sembler surprenant par rapport √† la question 2,
mais il n‚Äôy a pas de contradiction : l‚Äôeffet de la pluie est absorb√© par
les autres variables (temp√©rature, n√©bulosit√©, vitesse du vent). Une
fois ces variables int√©gr√©es, la pr√©sence ou non de pluie ne fournit
aucune information suppl√©mentaire. En revanche, si ces variables ne sont
pas prises en compte, l‚Äôeffet de la pluie devient tr√®s perceptible (voir
question 2), ce qui en fait un facteur de confusion.

:::

:::

## Question 5

De m√™me : repr√©senter graphiquement $\texttt{maxO3}$ en fonction de la direction du vent
et √©tudier la pertinence d‚Äôinclure un effet vent dans le mod√®le initial.

::: {.content-visible when-meta="is_answer_print_5"}

::: answer

On trace les boxplots selon les modalit√©s de la variables vent.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
# Boxplot
boxplot(
  maxO3 ~ vent,
  data = data_ozone,
  main = "Distribution de la quantit√© d'ozone selon la direction du vent"
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
# Boxplot
ggplot2::ggplot(
  data = subset(data_ozone, !is.na(vent) & !is.na(maxO3)),
  mapping = ggplot2::aes(x = pluie, y = maxO3, fill = pluie)
) +
  ggplot2::geom_boxplot(alpha = 0.7) +
  ggplot2::labs(
    title = "Distribution de la quantit√© d'ozone selon la direction du vent",
    x = "Direction du vent",
    y = "Quantit√© d'ozone"
  ) +
  ggplot2::theme_minimal()
```
:::

Un test de Student n'est pas appropri√© ici, car il y a quatre modalit√©s.
Nous effectuons donc un test ANOVA pour d√©terminer si les moyennes de
$\texttt{maxO3}$ diff√®rent significativement selon les directions du vent. Avant
cela, il est n√©cessaire de v√©rifier l'√©galit√© des variances, une
hypoth√®se essentielle pour l'ANOVA.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::leveneTest(maxO3 ~ vent, data = data_ozone)
bartlett.test(maxO3 ~ vent, data = data_ozone)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::leveneTest(maxO3 ~ vent, data = data_ozone)
bartlett.test(maxO3 ~ vent, data = data_ozone)
```
:::

L'√©galit√© des variances est confirm√©e dans ces deux tests. On peut
r√©aliser le test ANOVA.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(lm(maxO3 ~ vent, data = data_ozone))
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(lm(maxO3 ~ vent, data = data_ozone))
```
:::

La non-√©galit√© des moyennes selon les directions de vent est
significative.

On lance √† pr√©sent le mod√®le de r√©gression avec vent et toutes les
interactions possibles.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
fit_q5 <- lm(formula = maxO3 ~ (T12 + Ne9 + Vx9 + maxO3v)*vent, data = data_ozone)
summary(fit_q5)
anova(fit_q1, fit_q5)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
fit_q5 <- lm(formula = maxO3 ~ (T12 + Ne9 + Vx9 + maxO3v)*vent, data = data_ozone)
summary(fit_q5)
anova(fit_q1, fit_q5)
```
:::

Les conclusions sont similaires √† celles obtenues avec la variable pluie
: il ne para√Æt pas pertinent d‚Äôajouter la variable $\texttt{vent}$ ni les
interactions associ√©es dans le mod√®le.

:::

:::
