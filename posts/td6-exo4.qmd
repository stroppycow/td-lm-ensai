---
title: "TD 6 - Exercice 4 - Pannes de voiture"
lang: fr
author: "Th√©o Leroy"
date: "14 novembre 2025"
params:
  question_courante: 0
format:
  live-html:
    code-background: true
    toc: true
    page-layout: full
webr:
  render-df: gt-interactive
  resources:
    - ./../data/break.csv
  packages:
      - dplyr
      - readr
      - ggplot2
editor: 
  mode: source
  markdown: 
    wrap: 72
fig-align: center
filters: 
  - custom-callout
custom-callout:    
  answer:
    color: "#CCCCCC"
    icon: true
    icon-symbol: "üìù"
    appearance: "default"
    title: "Correction"
---

{{< include ./../_extensions/conditionnal.qmd >}}
{{< include ./../_extensions/r-wasm/live/_knitr.qmd >}}

On consid√®re les donn√©es `break`. 
Ce jeu de donn√©es, de taille $n = 33$, comporte trois variables ayant trait
√† l‚Äô√©tat d‚Äôune automobile :

- Une variable $\texttt{fault}$ qui vaut 1 si la voiture concern√©e a connu une panne, 0 sinon ;
- Une variable $\texttt{age}$ qui donne l‚Äô√¢ge de la voiture ;
- Une variable $\texttt{brand}$  qui donne la marque de la voiture.

Le but de l‚Äôexercice est de mod√©liser la variable $\texttt{fault}$.

## Question 1

Importer les donn√©es sous {{< iconify logos:r-lang >}} et recoder la classe
de chaque variable si n√©cessaire.

::: {.content-visible when-meta="is_answer_print_1"}

::: answer

Importons le fichier de donn√©es `break.csv` en {{< iconify logos:r-lang >}} sous forme de
`data.frame`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
data_break <- read.csv(
  file = 'data/break.csv',
  header = TRUE,
  sep = ",",
  colClasses = c("fault"="factor", "age"="integer", "brand"="factor") 
)
data_break
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_break <- readr::read_delim(
  file = "data/break.csv",
  col_types = readr::cols(
    readr::col_factor(),
    readr::col_integer(),
    readr::col_factor(levels = c("0", "1", "2"))
  ),
  delim = ","
)
data_break
```
:::

La variable $\texttt{age}$ est quantitative (l'√¢ge de la voiture) alors que
$\texttt{brand}$ (la marque) est qualitative. On transforme la variable $\texttt{brand}$
en type `factor`.

Cette transformation est importante pour l'estimation de mod√®les par la
suite avec la fonction `glm`. Cette transformation permet d'automatiser
la dichotomisation de cette variable qualitative dans les mod√®les.

:::

:::

## Question 2

Observer graphiquement le lien √©ventuel entre $\texttt{fault}$ et $\texttt{age}$ d‚Äôune part,
et entre $\texttt{fault}$ et $\texttt{brand}$ d‚Äôautre part.

::: {.content-visible when-meta="is_answer_print_2"}

::: answer

**Lien entre $\texttt{fault}$ et $\texttt{age}$**

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
boxplot(
  age ~ fault, 
  data = data_break, 
  col = "#F2F2F2", 
  names = c("N'a pas connu de panne", "A connu une panne"), 
  xlab = "", 
  ylab = "√Çge"
)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(
  data = data_break,
  mapping = ggplot2::aes(x=fault, y=age,)
) +
  ggplot2::geom_boxplot(fill='#F2F2F2') +
  ggplot2::labs(x=NULL, y="√Çge") +
  ggplot2::scale_x_discrete(labels = c("1"="A connu une panne", "0"="N'a pas connu de panne")) +
  ggplot2::theme_light() 
```
:::

Le lien entre l'√¢ge de la voiture et la pr√©sence de panne n'est pas tr√®s
clair sur ce diagramme en bo√Æte. On remarque seulement que les voitures
plus ag√©es ont connu des pannes. On observe √©galement la forte variance
d'√¢ge des voitures connaissant des pannes contrairement aux autres. On
peut poursuivre l'analyse graphique pour mieux comprendre ces
diff√©rences d'√¢ges pour les voiture en panne.

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
# D√©finir les couleurs
colors <- c("0" = adjustcolor("powderblue", alpha.f = 0.7), "1" = adjustcolor("pink", alpha.f = 0.7))

# D√©finir les √©tiquettes
labels <- c("0" = "Absence de panne", "1" = "Panne")

# Dessiner l'histogramme
hist(
  data_break[data_break$fault == "0", "age"],
  main = "Distribution de l'√¢ge du v√©hicule selon la pr√©sence de panne",
  xlab = "Age",
  ylab = "Fr√©quence",
  col = colors["0"],
  xlim = c(0, 16),
  ylim = c(0, 8),
  breaks = seq.int(from = 0, to = 16)
)
hist(
  data_break[data_break$fault == "1", "age"],
  col = colors["1"],
  add = TRUE,
  breaks = seq.int(from = 0, to = 16)
)

# Ajout d'une l√©gende
legend(
  "topright", 
  legend = labels, 
  fill = colors, 
  title = "√âtat"
)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(
  data = data_break,
  mapping = ggplot2::aes(x=age, fill=fault)
) +
  ggplot2::geom_histogram(binwidth = 1) +
  ggplot2::labs(x="√Çge", y="Nombre de voitures") +
  ggplot2::scale_fill_manual(
    values = c("1"="#F24B4B", "0"="#949FA6"),
    labels = c("1"="Panne", "0"="Absence de panne"),
    name = "√âtat"
  ) +
  ggplot2::theme_light() 
```
:::

Bien que le nombre d'observations soit tr√®s faible, ce graphique
correspond plut√¥t bien √† la [courbe en
baignoire](https://fr.wikipedia.org/wiki/Courbe_en_baignoire) qui rend
compte de l'√©volution du taux de panne d'un √©quipement. On d√©compose
g√©n√©ralement cette courbe en 3 phases.

-   La premi√®re p√©riode dite de rodage se caract√©rise par un taux de
    panne relativement important, mais en d√©croissance, correspondant √†
    l'√©limination des d√©fauts de jeunesse et au rodage.
-   La deuxi√®me p√©riode de "vie utile" se caract√©rise par un taux de
    panne faible et constant. Les diff√©rents composants ont prouv√©s leur
    robustesse aux d√©fauts de jeunesse, l'√©quipement est dans sa phase
    de maturit√©.
-   La derni√®re p√©riode est celle du vieillissement et d'usure. La
    proportion de panne croit avec le temps.

**Lien entre $\texttt{fault}$ et $\texttt{brand}$**

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
proportions <- prop.table(table(data_break$brand, data_break$fault), margin = 1)

# D√©finir les couleurs
colors <- c("0" = "#949FA6", "1" = "#F24B4B")

# Cr√©ation du graphique
barplot(
  t(proportions), # Transpose pour aligner les barres par marque
  beside = FALSE, 
  col = colors, 
  xlab = "Marque", 
  ylab = "Proportion", 
  border = NA, 
  legend.text = c("Absence de panne", "Panne"),
  args.legend = list(x = "bottom", bty = "o", title = "√âtat", horiz = TRUE)
)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(
  data = data_break,
  mapping = ggplot2::aes(x = brand, fill = fault, by = brand
)) +
  ggplot2::geom_bar(position = "fill") +
  ggplot2::geom_text(aes(label = after_stat(count)), stat = "count", position= position_fill(vjust = 0.5)) +
  ggplot2::labs(x = "Marque", y = "Proportion") +
  ggplot2::scale_fill_manual(
    values = c("1"="#F24B4B", "0"="#949FA6"),
    labels = c("1"="Panne", "0"="Absence de panne"),
    name = "√âtat"
  ) +
  ggplot2::theme_light() +
  ggplot2::theme(legend.position = "bottom")
```
:::

Ce graphique semble indiquer que la marque "2" est plus fiable que les
autres marques, cependant, les donn√©es recueillies sont limit√©es en
effectif.

:::

:::

## Question 3

On souhaite mettre en oeuvre un mod√®le de r√©gression logistique expliquant la probabilit√©
d‚Äôavoir une panne en fonction de l‚Äô√¢ge de la voiture et de sa marque. Lancer
cette mod√©lisation sous {{< iconify logos:r-lang >}} et √©crire la formule math√©matique du mod√®le obtenu. On
pr√©cisera en particulier le mod√®le estim√© sp√©cifique aux voitures de la marque 0, puis
de la marque 1, puis de la marque 2.

::: {.content-visible when-meta="is_answer_print_3"}

::: answer

Estimons un mod√®le de r√©gression logistique avec toutes les variables
explicatives √† notre disposition en utilisant la fonction `glm`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q3 <- glm(
  formula = fault ~ age+brand,
  family = binomial(link='logit'),
  data = data_break
)
summary(modele_q3)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q3 <- glm(
  formula = fault ~ age+brand,
  family = binomial(link='logit'),
  data = data_break
)
summary(modele_q3)
```
:::

La variable indiquant la pr√©sence de panne pour le v√©hicule
conditionnellement √† l'√¢ge et la suit une loi de Bernoulli de param√®tre
d√©pendant de l'√¢ge et de la marque du v√©hicule.

Math√©matiquement, le mod√®le logistique estim√© s'√©crit :
$$\texttt{fault}|(\texttt{age}=x_{\texttt{age}},\texttt{brand}=x_{\texttt{brand}}) \sim \mathcal{B}(p(x_{\texttt{age}},x_{\texttt{brand}}))$$

avec

$$ \textrm{logit}(p(x_{\texttt{age}},x_{\texttt{brand}}))=\beta_0+\beta_1x_\texttt{age}  + \beta_{21}\mathbb{1}_{x_\texttt{brand}=1}+ \beta_{22}\mathbb{1}_{x_\texttt{brand}=2}$$

Pour int√©grer une variable explicative cat√©gorielle dans un mod√®le
statististique comme ici $\texttt{brand}$, on "dichotomise" la variable,
c'est-√†-dire qu'on transforme chaque modalit√© en une nouvelle variable
indicatrice de la pr√©sence de cette modalit√©. Comme la variable $\texttt{brand}$
comporte 3 modalit√©s $\{0,1,2\}$. On peut faire apparaitre 3 indiatrices
dans l'expression du mod√®le :
$\beta_{20}\mathbb{1}_{x_\texttt{brand}=0}+\beta_{21}\mathbb{1}_{x_\texttt{brand}=1}+ \beta_{22}\mathbb{1}_{x_\texttt{brand}=2}$.

Toutefois, pour rendre le mod√®le identifiable il faut imposer une
contrainte sur les coefficients $\beta_{20}$, $\beta_{21}$ et
$\beta_{22}$ car on a toujours
$\mathbb{1}_{\texttt{brand}=0}+\mathbb{1}_{\texttt{brand}=1}+\mathbb{1}_{\texttt{brand}=2}=1$.
Ici la fonction `glm` a choisi d'imposer $\beta_{20}=0$.

Si on d√©taille l'expression du mod√®le par marque comme demand√© dans
l'enonc√©, on a:

$$
\begin{align*}
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=0))=\beta_0+\beta_1x_\texttt{age} \\
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=1))=\beta_0+\beta_1x_\texttt{age}+\beta_{21} \\
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=2))=\beta_0+\beta_1x_\texttt{age}+\beta_{22} \\
\end{align*}
$$

Le coefficient $\beta_{21}$ (respectivement $\beta_{22})$ s'interpr√®tent
comme l'effet propre de la marque marque 1 (resp. 2) par rapport √† la
marque de r√©f√©rence 0.

::: {.callout-note collapse="true"}
### Remarque

On peut d√©finir les contraintes si on ne souhaite pas conserver le choix
par d√©faut de la m√©thode `glm`. On peut alors utiliser le param√®tre
`contrasts`.

On pourait, par exemple, choisir la deuxi√®me modalit√© modalit√© (i.e.
`brand=1`) comme r√©f√©rence :

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q3_bis <- glm(
  formula = fault ~ age +brand,
  family = binomial(link = 'logit'),
  contrasts =  list(brand = contr.treatment(sort(levels(data_break$brand)), base =2)),
  data = data_break
)
summary(modele_q3_bis)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q3_bis <- glm(
  formula = fault ~ age +brand,
  family = binomial(link = 'logit'),
  contrasts =  list(brand = contr.treatment(sort(levels(data_break$brand)), base =2)),
  data = data_break
)
summary(modele_q3_bis)
```
:::

Dans ce cas, on estime le mod√®le

$$
\begin{align*}
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=0))=\alpha_0+\alpha_1x_\texttt{age} + \alpha_{20} \\
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=1))=\alpha_0+\alpha_1x_\texttt{age} \\
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=2))=\alpha_0+\alpha_1x_\texttt{age}+ \alpha_{22} \\
\end{align*}
$$

Ou encore, on pourrait imposer la sommation √† z√©ro des coefficients
associ√©s aux indicatrices pour la variable $\texttt{brand}$ :

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q3_ter <- glm(
  formula = fault ~ age + brand,
  family = binomial(link='logit'),
  contrasts =  list(brand = contr.sum(sort(levels(data_break$brand)))),
  data = data_break
)
summary(modele_q3_ter)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q3_ter <- glm(
  formula = fault ~ age + brand,
  family = binomial(link='logit'),
  contrasts =  list(brand = contr.sum(sort(levels(data_break$brand)))),
  data = data_break
)
summary(modele_q3_ter)
```
:::

Attention ici, le nommage n'est pas variables indicatrices dans la
sortie peut √™tre une source d'erreur d'interpr√©tation car 1 et 2 sont
aussi des modalit√©s de la variable $\texttt{brand}$. La variable `brand1`
correspond √† la premi√®re variable de contraste pour $\texttt{brand}$ et non √† une
indicatrice la marque 1. On peut s'en convaincre en renommant les
modalit√©s par des lettres ; les variables `brand1` et `brand2`
apparaitront tout de m√™me dans la sortie. Le mod√®le estim√© ici est donc
:

$$
\begin{align*}
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=0))=\gamma_0+\beta_1x_\texttt{age} + \gamma_{21}  \\
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=1))=\gamma_0+\beta_1x_\texttt{age} + \gamma_{22}\\
\textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}&=x_{\texttt{age}},\texttt{brand}=2))=\gamma_0+\beta_1x_\texttt{age}  - \gamma_{22} - \gamma_{22} \\
\end{align*}
$$

L'int√©ret de cette mod√©lisation est de raisonner par rapport au cas
moyen
$$\gamma_0=\frac{\sum\limits_{i=0}^2 \textrm{logit}(\mathbb{P}(\texttt{fault}=1 | \texttt{age}=0,\texttt{brand}=i))}{3}$$

Le choix de contraintes/contrastes est simplement un choix de
param√©trisation et ne change en rien la qualit√© du mod√®le. Toutes ces
estimations sont parfaitement coh√©rentes entre elles : le coefficient
associ√© √† l'√¢ge, la vraisemblance ou la d√©viance sont les m√™mes. Par
ailleurs, les estimations pour l'effet propre de la marque sont les
m√™mes car on a :

$$
\begin{align*}
\hat{\beta}_0 &= \hat{\alpha}_0 + \hat{\alpha}_{20} &&= \hat{\gamma}_0+ \hat{\gamma}_{21} &&&= 0.47808\\
\hat{\beta}_0+\hat{\beta}_{21} &= \hat{\alpha}_0  &&= \hat{\gamma}_0+ \hat{\gamma}_{22} &&&= -0.05867 \\
\hat{\beta}_0+\hat{\beta}_{22} &=  \hat{\alpha}_0 + \hat{\alpha}_{21} &&= \hat{\gamma}_0- \hat{\gamma}_{21}-\hat{\gamma}_{22} &&&= -0.978 \\
\end{align*}
$$
:::

:::

:::

## Question 4

Analyser la qualit√© globale du mod√®le.

::: {.content-visible when-meta="is_answer_print_4"}

::: answer

Pour √©valuer la pertinence du mod√®le, on peut r√©aliser un test de
rapport de vraisemblance entre le mod√®le et le mod√®le nul.

L'hypoth√®se nulle $H_0$ est $\beta_1=\beta_{21}=\beta_{22}=0$

Sous $H_0$, la statitique de test du rapport de vraisemblance :
$$ -2 \ln\left(\frac{L_n^{(\textrm{nul})}}{L_n(\widehat{\beta_n})}\right) \sim \chi^2(d-1)$$

avec :

-   $L_n^{(\textrm{nul})}$ : la vraisemblance du mod√®le nul (i.e. ou la
    probabilit√© d'avoir une panne ne d√©pend pas d'autres variables)
-   $L_n(\widehat{\beta_n})$ : la vraisemblance du mod√®le complet (tel
    que d√©crit dans la question 3)
-   $d$ : le nombre de coefficients √† estimer dans le mod√®le complet

La valeur de cette statististique de test peut √™tre calcul√© facilement √†
partir des sorties ci-dessus (il s'agit de
$\texttt{Null deviance}-\texttt{Residual deviance}$ car : 

$$
\begin{align*}
\texttt{Null deviance}&=-2\ln\left(\frac{L_n^{(\textrm{nul})}}{L_n^{(sat)}}\right) \\
\texttt{Residual deviance}&=-2\ln\left(\frac{L_n(\widehat{\beta_n})}{L_n^{(sat)}}\right)
\end{align*}
$$

On a :

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q3$null.deviance-modele_q3$deviance
qchisq(0.95,3)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q3$null.deviance-modele_q3$deviance
qchisq(0.95,3)
```
:::

Le quantile 0.95 d'une $\chi^2$ √† 3 degr√©s de libert√© est sup√©rieur √† la
statistique de test. On ne rejette pas l'hypoth√®se nulle pour un risque
de premi√®re esp√®ce $\alpha=0.05$.

On pouvait faire ce test en {{< iconify logos:r-lang >}} directement avec l'instruction `anova`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(
  glm(formula = fault ~ 1, family = binomial(),  data = data_break),
  modele_q3,
  test = 'Chisq'
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(
  glm(formula = fault ~ 1, family = binomial(),  data = data_break),
  modele_q3,
  test = 'Chisq'
)
```
:::

Ce qui donne √©galement une $\textit{p-value}$ de 0.529. Le mod√®le n'est
donc globalement pas significatif.

:::

:::

## Question 5

Recommencer la mod√©lisation en incluant seulement la variable $\texttt{age}$ dans le mod√®le.
Est-ce mieux ?

::: {.content-visible when-meta="is_answer_print_5"}

::: answer

On construit un nouveau mod√®le avec seulement un terme lin√©aire en $\texttt{age}$
et la constante. Ce mod√®le s'√©crit :

$$
\texttt{fault}|(\texttt{age}=x_{\texttt{age}}) \sim \mathcal{B}(p(x_{\texttt{age}}))
$$

avec

$$
\textrm{logit}(p(x_{\texttt{age}}))=\beta_0+\beta_1x_\texttt{age}
$$

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q5 <- glm(
  formula = fault ~ age,
  family = binomial(link = 'logit'),
  data = data_break
)
summary(modele_q5)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q5 <- glm(
  formula = fault ~ age,
  family = binomial(link = 'logit'),
  data = data_break
)
summary(modele_q5)
```
:::

Ce mod√®le ne semble pas beaucoup mieux. La variable $\texttt{age}$ n'est pas
significative dans ce mod√®le pour un seuil d'erreur de 5 %. Le fait que
la variable $\texttt{age}$ ne soit pas significative dans le mod√®le est
surprenant, en g√©n√©ral les voitures plus anciennes ont plus de risque de
tomber en panne.

:::

:::

## Question 6

Le nuage de points entre la variable $\texttt{age}$ et la variable $\texttt{fault}$
semble sugg√©rer que les pannes ont lieu en d√©but de vie du v√©hicule 
("d√©fauts de jeunesse" ou de "rodage") et en fin de vie (pannes d‚Äôusure).
Ce comportement de la probabilit√© de pannes en forme de parabole nous incite
√† essayer d‚Äôinclure un terme quadratique en la variable $\texttt{age}$.
Effectuer cet ajout dans le mod√®le en incluant √©galement la variable $\texttt{brand}$ et
analyser les r√©sultats. Le mod√®le est-il significatif ?

::: {.content-visible when-meta="is_answer_print_6"}

::: answer

Le mod√®le estim√© est d√©sormais :

$$
\texttt{fault}|(\texttt{age}=x_{\texttt{age}},\texttt{brand}=x_{\texttt{brand}}) \sim \mathcal{B}(p(x_{\texttt{age}},x_{\texttt{brand}}))
$$

avec

$$\textrm{logit}(p(x_{\texttt{age}},x_{\texttt{brand}}))=\beta_0+\beta_1x_\texttt{age}+\beta_2x_\texttt{age}^2+\beta_{31}\mathbb{1}_{x_\texttt{brand}=1}+ \beta_{32}\mathbb{1}_{x_\texttt{brand}=2}$$

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q6 <- glm(
  formula = fault ~ age + I(age**2) + brand,
  family = binomial(link='logit'),
  data = data_break
)
summary(modele_q6)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q6 <- glm(
  formula = fault ~ age + I(age**2) + brand,
  family = binomial(link='logit'),
  data = data_break
)
summary(modele_q6)
```
:::

On peut r√©aliser un test de significativ√© globale de d√©viance.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(
  glm(formula = fault ~ 1, family = binomial(),  data = data_break),
  modele_q6,
  test = 'Chisq'
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(
  glm(formula = fault ~ 1, family = binomial(),  data = data_break),
  modele_q6,
  test = 'Chisq'
)
```
:::

On rejette l'hypoth√®se nulle de globalit√© de tous les coefficients en
dehors de la constante au seuil 5 % car la $\textit{p-value}$ est inf√©rieure √† 0,05.
Le mod√®le est significatif cette fois-ci.

:::

:::

## Question 7

Que vaut l‚Äôodds ratio associ√© √† la marque "2" par rapport √† la marque "0" de la
variable $\texttt{brand}$ ? Interpr√©ter cette valeur et donner un intervalle de
confiance √† 95 % autour de cette estimation. L‚Äôinclusion de la variable $\texttt{brand}$
dans le mod√®le est-il pertinent ?

::: {.content-visible when-meta="is_answer_print_7"}

::: answer

L'odds d'avoir une panne
$\texttt{fault}=1|(\texttt{fault}|(\texttt{age}=x_{\texttt{age}},\texttt{brand}=x_{\texttt{brand}})$
est :

$$
\begin{align*}
\texttt{odds}(x_{\texttt{age}}, x_{\texttt{brand}}) &= \frac{\mathbb{P}(\texttt{fault}=1|(\texttt{age}=x_{\texttt{age}},\texttt{brand}=x_{\texttt{brand}}))}{1-\mathbb{P}(\texttt{fault}=1|(\texttt{age}=x_{\texttt{age}},\texttt{brand}=x_{\texttt{brand}}))} \\
&= \exp(\textrm{logit}(\mathbb{P}(\texttt{fault}=1|(\texttt{age}=x_{\texttt{age}},\texttt{brand}=x_{\texttt{brand}}))))
\end{align*}
$$

Ainsi pour un individu avec des caract√©ristiques
$\textbf{x}=(x_{\texttt{age}}, x_{\texttt{brand}}=2)$ et un autre
individu avec les caract√©ristiques
$\textbf{x}'=(x_{\texttt{age}}, x_{\texttt{brand}}=0)$, on a :

$$
\texttt{OR}(\textbf{x},\textbf{x}') = \frac{\texttt{odds}(\textbf{x})}{\texttt{odds}(\textbf{x}')}=\frac{\exp(\beta_0+\beta_1x_\texttt{age}+\beta_2x_\texttt{age}^2+\beta_{32})}{\exp(\beta_0+\beta_1x_\texttt{age}+\beta_2x_\texttt{age}^2)}=\exp(\beta_{32})
$$

On peut estimer cet odds-ratio avec $\exp(\hat{\beta}_{32})$.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
exp(modele_q6$coefficients[5])
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
exp(modele_q6$coefficients[5])
```
:::

On peut interpr√©ter ce coefficient comme suit :

> Toutes choses √©gales par ailleurs, la cote d'avoir une panne pour une
> voiture de marque 2 est 3 fois plus faible que pour la marque 0.

::: {.callout-warning mode="simple"}
### Un odds-ratio n'est pas un rapport de risque

On peut √™tre tent√© d'interpr√©ter cette quantit√© comme un rapport de
risque, mais c'est faux (sauf pour des √©v√®nements rares). On n'√©crit
donc pas :

> Toutes choses √©gales par ailleurs, la ~~probabilit√©~~ d'avoir une
> panne pour une voiture de marque 2 est 3 fois plus faible que pour la
> marque 0.

ou encore

> Toutes choses √©gales par ailleurs, les voitures de marque 2 ont trois
> fois moins de ~~chances~~ de tomber en panne que pour la marque 0.
:::

On vient d'interpr√©ter ces coefficients car c'est ce qui est demand√©
dans l'exercice mais en principe on ne commente pas des effets qui ne
sont pas significatifs. Le nombre d'observations est ici trop faible
donc l'√©cart type du coefficient estim√© pour $\beta_{32}$ est bien trop
grand. On le voit avec cet intervalle de confiance √† 95 % qu'on peut
obtenir avec `confint`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
exp(confint.default(modele_q6, parm = "brand2"))
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
exp(confint.default(modele_q6, parm = "brand2"))
```
:::

Comme 1 appartient l'intervalle de confiance √† 95 %, cet odds-ratio
n'est pas significativement diff√©rent de 1 compte tenu des donn√©es
disponibles.

Pour tester, globalement la significativit√© de $\texttt{brand}$, on peut faire un
test de d√©viance pour des mod√®les emboit√©s. L'hypoth√®se nulle est
$H_0: \ \beta_{31}=\beta_{32}=0$.

Sous $H_0$,

$$ D_{H_0} - D_{H_1} \underset{H_0}{\sim} \chi^2(2)$$ On ne rejette pas
l'hypoth√®se nulle ici car on a :

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
glm(
  formula = (as.numeric(fault) - 1) ~ age + I(age**2),
  family = binomial(link='logit'),
  data = data_break
)$deviance-modele_q6$deviance
qchisq(p = 0.95, df = 2)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
glm(
  formula = (as.numeric(fault) - 1) ~ age + I(age**2),
  family = binomial(link='logit'),
  data = data_break
)$deviance-modele_q6$deviance
qchisq(p = 0.95, df = 2)
```
:::

La variable $\texttt{brand}$ ne semble pas √™tre significative.

On pouvait √©galement faire ce test plus rapidement avec `anova`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(glm(
  formula = fault ~ age + I(age**2),
  family = binomial(link='logit'),
  data = data_break
), modele_q6, test = 'Chisq')
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(glm(
  formula = fault ~ age + I(age**2),
  family = binomial(link='logit'),
  data = data_break
), modele_q6, test = 'Chisq')
```
:::

:::

:::
