---
title: "TD 2 - Exercice 10 - ANOVA à 1 facteur : effet du dosage d’un médicament"
lang: fr
author: "Théo Leroy"
date: "17 octobre 2025"
format:
  live-html:
    code-background: true
    toc: true
    page-layout: full
webr:
  render-df: gt-interactive
  resources:
    - ./../data/chemical.txt
  packages:
      - dplyr
      - readr
      - ggplot2
      - car
editor: 
  mode: source
  markdown: 
    wrap: 72
fig-align: center
filters: 
  - diagram
  - custom-callout
custom-callout:    
  answer:
    color: "#CCCCCC"
    icon: false
    icon-symbol: ""
    appearance: "default"
    title: "Correction"
---

{{< include ./../_extensions/r-wasm/live/_knitr.qmd >}}

Le fichier `chemical.txt` contient la concentration dans le sang (en *ng=ml*) d’un certain 
produit chimique chez 40 patients selon qu’ils ont absorbé un médicament dosé à 
25, 50, 100 ou 200 mg de substance active (l’almitrine bismesylate). Les patients sont ainsi 
séparés en 4 groupes de 10 selon le dosage reçu.


## Question 1

Représenter les données à l’aide de boîtes à moustaches. Réordonner si nécessaire les 
niveaux du facteur dose pour avoir une représentation par ordre croissant du dosage. 
Les hypothèses nécessaires à une analyse de variance de l’effet dosage semblent-elles 
vérifiées ?

::: {.content-hidden when-format="html"}
::: answer

On charge les données du fichier `chemical.txt` en {{< iconify logos:r-lang >}} sous forme de `data.frame`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
data_chemical <- read.csv(
  file = "data/chemical.txt",
  header = TRUE,
  sep = " ",
  quote = '"',
  colClasses = c("", "factor", "numeric")
)
data_chemical$dose <- factor(
  data_chemical$dose,
  levels= c("dose25", "dose50", "dose100", "dose200")
)
data_chemical
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_chemical <- readr::read_delim(
  file = "data/chemical.txt",
  col_names = c("dose", "concent"),
  col_types = readr::cols(
    readr::col_skip(),
    readr::col_factor(levels = c("dose25", "dose50", "dose100", "dose200"))
  ),
  skip = 1,
  delim = " ",
  quote = '"'
)
data_chemical
```
:::

Le fichier chargé contient bien les 40 observations attendues (4 groupes $\times$ 10 individus) avec les 
variables $\texttt{dose}$ pour la dose de principae actif administrée et $\texttt{concent}$ pour la 
concentration dans le sang d'un certain produit chimique.


On représente les concentrations dans des boîtes à moustaches pour les différents groupes du test clinique.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
boxplot(concent ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(data=data_chemical, mapping=ggplot2::aes(x=dose, y=concent)) +
  ggplot2::geom_boxplot(fill='#F2F2F2') +
  ggplot2::labs(x="Dosage", y="Concentration") +
  ggplot2::scale_x_discrete(
    labels = c("dose25"= "25 mg", "dose50"="50 mg", "dose100"="100 mg", "dose200"="200 mg")
  ) +
  ggplot2::theme_light() 
```
:::

Graphiquement, les variances ne  présentent pas d’homogénéité entre les groupes définis par les différentes modalités de dose, ce qui contredit l’hypothèse d’homoscédasticité requise pour l’ANOVA.

::: {.callout-note collapse="true"}
### Rappel sur les diagrammes en boîte

La boîte à moustaches résume seulement quelques indicateurs de position
sur une variable quantitative. Le *package* `ggplot2` représente les
statistiques ci-dessous :

![](/static/img/boxplot.svg){fig-align="center"}
:::
:::
:::

## Question 2

Effectuer un test d’égalité de variance de Bartlett (`bartlett.test`) et de Levene
(`leveneTest` dans la librairie `car`) pour confirmer le problème vu précédemment.

::: {.content-hidden when-format="html"}
::: answer

On effectue les deux tests d’égalité de variance proposés.  L’hypothèse nulle ($H_0$) postule que 
les variances intra-groupes sont égales pour l’ensemble des modalités.


**Test de Bartlett**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
bartlett.test(concent ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
bartlett.test(concent ~ dose, data = data_chemical)
```
:::

**Test de Levene**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::leveneTest(concent ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::leveneTest(concent ~ dose, data = data_chemical)
```
:::

Les p-valeurs sont bien inférieures à $0,05$ dans les deux tests effectués. 
On rejette donc l'hypothèse nulle. Ils confirment l'analyse graphique que les variances ne sont pas identiques.

:::
:::

## Question 3

On propose de s’intéresser à une transformation logarithmique de la variable $\texttt{concent}$. 
Représenter les boîtes à moustaches des données transformées. Effectuer des tests 
d’égalité des variances pour vérifier la stabilité des variances après transformation.

::: {.content-hidden when-format="html"}
::: answer

On reproduit les deux premières questions en s'interessant à $\ln(\texttt{concent})$.

**Analyse graphique**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
boxplot(log(concent) ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(data=data_chemical, mapping=ggplot2::aes(x=dose, y=log(concent))) +
  ggplot2::geom_boxplot(fill='#F2F2F2') +
  ggplot2::labs(x="Dosage", y="Concentration (log)") +
  ggplot2::scale_x_discrete(
    labels = c("dose25"= "25 mg", "dose50"="50 mg", "dose100"="100 mg", "dose200"="200 mg")
  ) +
  ggplot2::theme_light() 
```
:::

**Test de Bartlett**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
bartlett.test(log(concent) ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
bartlett.test(log(concent) ~ dose, data = data_chemical)
```
:::

**Test de Levene**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::leveneTest(log(concent) ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::leveneTest(log(concent) ~ dose, data = data_chemical)
```
:::

La transformation appliquée a permis de stabiliser les variances.

:::
:::

## Question 4

Réaliser l’analyse de la variance et tester l’effet du dosage sur la concentration en
produit chimique.


::: {.content-hidden when-format="html"}
::: answer

On pourrait modéliser l'effet du dosage sur la concentration en produit chimique comme ceci :

$$
\forall\ i \in [\![1,n]\!], \quad \ln(\texttt{concent}_i)=m+\alpha_1\mathbb{1}_{\texttt{dose}=25mg}+\alpha_2\mathbb{1}_{\texttt{dose}=50mg}+\alpha_3\mathbb{1}_{\texttt{dose}=100mg}+\alpha_4\mathbb{1}_{\texttt{dose}=200mg}+\epsilon_i
$$

Ce modèle n’est pas de plein rang et donc non identifiable car $\mathbb{1}=\mathbb{1}_{\texttt{dose}=25mg}+\mathbb{1}_{\texttt{dose}=50mg}+\mathbb{1}_{\texttt{dose}=100mg}+\mathbb{1}_{\texttt{dose}=200mg}$

Il faut donc imposer une contrainte par exemple $\alpha_1=0$ comme le propose {{< iconify logos:r-lang >}} par défaut.

On estime ce modèle puis on teste la significativité du facteur $\texttt{dose}$ avec la fonction `anova`. L'hypothèse nulle $H_0$ est $\alpha_2=\alpha_3=\alpha_4=0$

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
reg <- lm(log(concent) ~ dose, data = data_chemical)
anova(reg)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
reg <- lm(log(concent) ~ dose, data = data_chemical)
anova(reg)
```
:::

La p-valeur du test de Fisher est très faible. On rejette donc $H_0$ c'est à dire qu’il y a au moins une moyenne de $ln(\texttt{concent})$ qui
diffère des autres selon le dosage effectué.

::: {.callout-note collapse="true"}
### Complément sur la sortie `anova`

La statistique de test est $F$ telle que 

$$
F = \frac{\frac{S^2_{\textrm{inter}}}{I-1}}{\frac{S^2_{\textrm{intra}}}{n-I}}
$$

avec 

* $n$ le nombre d'observations
* $I$ le nombre de groupes, c'est à dire de modalités de la variable explicative qualitative
* $\forall\ i \in [\![1,I]\!]$, $n_i$ désigne le nombre d'observations dans le groupe $i$ et $\overline{Y_i}$ la moyenne de la variable $Y$ dans le groupe $i$ 
* $S^2_\textrm{inter}$ : la somme des carrés inter-modalités 
    $$S^2_\textrm{inter}=\sum\limits_{i=1}^I n_i\left(\overline{Y}_i-\overline{Y}\right)^2$$
* $S^2_\textrm{intra}$ : la somme des carrés intra-modalités 
    $$S^2_\textrm{inter}=\sum\limits_{i=1}^I \sum\limits_{j=1}^{n_i} \left(Y_{ij}-\overline{Y_i}\right)^2$$

On retrouve ces quantités dans la sorties de la fonction `anova`.

|`Df` | `Sum Sq`   | `Mean Sq`  | `F value`  | `Pr(>F)`  |
|---|---|---|---|---|
| $I-1$  | $S^2_\textrm{inter}$   | $\frac{S^2_{\textrm{inter}}}{I-1}$  | $F$  |  $1-F_{\mathcal{F}(I-1, \ n-I)}(F)$ |
| $n-I$   | $S^2_\textrm{intra}$  | $\frac{S^2_{\textrm{intra}}}{n-I}$  |   |   |

On pouvait calculer toutes ces valeurs sans utiliser directement la fonction `anova`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
n <- nrow(data_chemical)
I <- length(levels(data_chemical$dose))
Y_bar <- mean(log(data_chemical$concent))
n_i <- sapply(
  X = levels(data_chemical$dose),
     FUN=function(x){sum(data_chemical$dose==x)}
)
Y_i_bar <- sapply(
  X = levels(data_chemical$dose),
  FUN=function(x){sum(as.numeric(data_chemical$dose==x)*log(data_chemical$concent))}
)/n_i
S2_inter <- sum(n_i*(Y_i_bar-rep(Y_bar, I))**2)
S2_intra <- sum((log(data_chemical$concent)-Y_i_bar[data_chemical$dose])**2)
Fstat <- (S2_inter/(I-1))/(S2_intra/(n-I))
pval <- 1-pf(q = Fstat, df1 = I-1, n-I)
cat(paste0("I-1 = ", I-1,"\n"))
cat(paste0("S²inter = ",S2_inter,"\n"))
cat(paste0("S²inter / (I-1) = ",S2_inter/(I-1),"\n"))
cat(paste0("n-I = ", n-I,"\n"))
cat(paste0("S²intra = ",S2_intra,"\n"))
cat(paste0("S²intra / (I-1) = ",S2_intra/(n-I),"\n"))
cat(paste0("F = ",Fstat,"\n"))
cat(paste0("p-value = ",pval,"\n"))

```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
n <- nrow(data_chemical)
I <- length(levels(data_chemical$dose))
Y_bar <- data_chemical |>
  dplyr::pull(concent) |>
  log() |>
  mean()

data_group <- data_chemical |> 
  dplyr::group_by(dose) |>
  dplyr::summarise(
    n_i = dplyr::n(),
    Y_i_bar = mean(log(concent)),
    .group = "drop"
  )
  
S2_inter <- data_group |>
  dplyr::mutate(
    x = n_i*(Y_i_bar-Y_bar)**2
  ) |>
  dplyr::pull(x) |>
  sum()
  
S2_intra <- data_chemical |>
  dplyr::left_join(y=data_group, by = "dose") |>
  dplyr::mutate(
    x = (log(concent)-Y_i_bar)**2
  ) |>
  dplyr::pull(x) |>
  sum()
  
Fstat <- (S2_inter/(I-1))/(S2_intra/(n-I))
pval <- 1-pf(q = Fstat, df1 = I-1, n-I)

cat(paste0("I-1 = ", I-1,"\n"))
cat(paste0("S²inter = ",S2_inter,"\n"))
cat(paste0("S²inter / (I-1) = ",S2_inter/(I-1),"\n"))
cat(paste0("n-I = ", n-I,"\n"))
cat(paste0("S²intra = ",S2_intra,"\n"))
cat(paste0("S²intra / (I-1) = ",S2_intra/(n-I),"\n"))
cat(paste0("F = ",Fstat,"\n"))
cat(paste0("p-value = ",pval,"\n"))
```
:::
:::
:::
:::

## Question 5 

Analyser à présent le résumé de la sortie de la fonction `lm` : à quoi correspond chaque
quantité ?

::: {.content-hidden when-format="html"}
::: answer

On appelle la fonction `summary` sur l'objet `reg` qui correspond à l'ajustement de notre modèle ANOVA.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
summary(reg)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
summary(reg)
```
:::

Le modèle inclut une constante `(Intercept)` ainsi que des variables indicatrices pour les modalités $\texttt{dose50}$, $\texttt{dose100}$ et $\texttt{dose200}$. La modalité $\texttt{dose25}$, absente du modèle, sert de modalité de référence.


L’interprétation des coefficients, et donc des tests de Student associés, dépend de la contrainte 
qui a été choisie initialement.

* La constante (3.6151) correspond à la moyenne dans la modalité de référence, c’est à dire la moyenne de $\ln(\texttt{concent})$ pour les observations ayant la modalité $\texttt{dose25}$. Les résultats du test de Student donnés sur cette première ligne permettent de déterminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalité $\texttt{dose25}$ est significativement différente de 0.
* L’estimation associée à $\texttt{dose50}$ (1.0072) correspondent à la différence entre la moyenne dans la modalité
$\texttt{dose50}$ et la moyenne dans la modalité $\texttt{dose25}$. Les résultats du test de Student donnés sur cette deuxième ligne permettent de déterminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalité $\texttt{dose50}$ est significativement différente de celle dans la modalité $\texttt{dose25}$.
* L’estimation associée à $\texttt{dose100}$ (1.6380) correspondent à la différence entre la moyenne dans la modalité
$\texttt{dose100}$ et la moyenne dans la modalité $\texttt{dose25}$. Les résultats du test de Student donnés sur cette troisième ligne permettent de déterminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalité $\texttt{dose100}$ est significativement différente de celle dans la modalité $\texttt{dose25}$.
* L’estimation associée à $\texttt{dose200}$ (1.9945) correspondent à la différence entre la moyenne dans la modalité
$\texttt{dose200}$ et la moyenne dans la modalité $\texttt{dose25}$. Les résultats du test de Student donnés sur cette quatrième ligne permettent de déterminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalité $\texttt{dose200}$ est significativement différente de celle dans la modalité $\texttt{dose25}$.

Tous ces tests de Student concluent que les coeffcients sont significatifs sont significatifs.

:::
:::

## Question 6

D’après la sortie précédente, quelles moyennes semblent différer des autres ? Effectuer
un test de Tukey pour identifier les différences significatives (si le modèle se nomme 
`reg` on peut lancer l'instruction `TukeyHSD(aov(reg))`) et représenter les intervalles de confiance associés (`plot`
du résultat).


::: {.content-hidden when-format="html"}
::: answer

La sortie commentée à la question précédente indique que la modalité $\texttt{dose25}$ présente une moyenne de $\ln(\texttt{concent})$ significativement inférieure à celle des autres dosages, avec une différence de l'ordre de 1 à 2 unités. Cependant, la comparaison entre les autres dosages est moins évidente. Bien qu'une tendance à l'augmentation de $\ln(\texttt{concent})$ avec le dosage soit observée, il n'est pas clair si cette augmentation est significative, notamment entre les modalités $\texttt{dose100}$ et $\texttt{dose200}$.

Pour résoudre cette incertitude, le test de Tukey est appliqué. Ce test permet de comparer les moyennes deux à deux tout en garantissant un niveau de confiance simultané de 5 % (ou tout autre seuil choisi). En outre, le test de Tukey fournit des intervalles de confiance (IC) simultanés à 95 %, ce qui signifie que la probabilité que toutes les différences de moyennes appartiennent à ces intervalles est de 95 %.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
TukeyHSD(aov(reg))
par(mar = c(5, 8, 4, 2) + 0.1)
plot(TukeyHSD(aov(reg)), las = 1)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
# Mise en oeuvre du test de Tukey
tukey <- TukeyHSD(aov(reg))

# Génération de la sortie graphique
tukey_df <- as.data.frame(tukey$dose)
tukey_df <- tukey_df |>
  dplyr::mutate(comparison = rownames(tukey_df))

ggplot2::ggplot(tukey_df, ggplot2::aes(x = comparison, y = diff)) +
  ggplot2::geom_point(size = 3) +
  ggplot2::geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  ggplot2::geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  ggplot2::coord_flip() +
  ggplot2::theme_minimal() +
  ggplot2::labs(
    title = "Test de Tukey",
    x = "Comparaison de groupes",
    y = "Différence des moyennes (IC à 95 %)"
  )
```
:::

En analysant les p-values des tests ainsi que les intervalles de confiance (IC), on observe que la dernière différence n'est pas significativement différente de 0. Cela indique un gain significatif lors de l'augmentation du dosage jusqu'à 100, mais un effet seuil semble apparaître, car le gain n'est plus significatif lorsque l'on passe de 100 à 200.

:::
:::