---
title: "TD 2 - Exercice 10 - ANOVA √† 1 facteur : effet du dosage d‚Äôun m√©dicament"
lang: fr
author: "Th√©o Leroy"
date: "17 octobre 2025"
params:
  question_courante: 6
format:
  live-html:
    code-background: true
    toc: true
    page-layout: full
webr:
  render-df: gt-interactive
  resources:
    - ./../data/chemical.txt
  packages:
      - dplyr
      - readr
      - ggplot2
      - car
editor: 
  mode: source
  markdown: 
    wrap: 72
fig-align: center
filters: 
  - diagram
  - custom-callout
custom-callout:    
  answer:
    color: "#CCCCCC"
    icon: true
    icon-symbol: "üìù"
    appearance: "default"
    title: "Correction"
---

{{< include ./../_extensions/conditionnal.qmd >}}
{{< include ./../_extensions/r-wasm/live/_knitr.qmd >}}

Le fichier `chemical.txt` contient la concentration dans le sang (en *ng/ml*) d‚Äôun certain 
produit chimique chez 40 patients selon qu‚Äôils ont absorb√© un m√©dicament dos√© √† 
25, 50, 100 ou 200 mg de substance active (l‚Äôalmitrine bismesylate). Les patients sont ainsi 
s√©par√©s en 4 groupes de 10 selon le dosage re√ßu.


## Question 1

Repr√©senter les donn√©es √† l‚Äôaide de bo√Ætes √† moustaches. R√©ordonner si n√©cessaire les 
niveaux du facteur dose pour avoir une repr√©sentation par ordre croissant du dosage. 
Les hypoth√®ses n√©cessaires √† une analyse de variance de l‚Äôeffet dosage semblent-elles 
v√©rifi√©es ?

::: {.content-visible when-meta="is_answer_print_1"}

::: answer

On charge les donn√©es du fichier `chemical.txt` en {{< iconify logos:r-lang >}} sous forme de `data.frame`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
data_chemical <- read.csv(
  file = "data/chemical.txt",
  header = TRUE,
  sep = " ",
  quote = '"',
  colClasses = c("", "factor", "numeric")
)
data_chemical$dose <- factor(
  data_chemical$dose,
  levels= c("dose25", "dose50", "dose100", "dose200")
)
data_chemical
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_chemical <- readr::read_delim(
  file = "data/chemical.txt",
  col_names = c("dose", "concent"),
  col_types = readr::cols(
    readr::col_skip(),
    readr::col_factor(levels = c("dose25", "dose50", "dose100", "dose200"))
  ),
  skip = 1,
  delim = " ",
  quote = '"'
)
data_chemical
```
:::

Le fichier charg√© contient bien les 40 observations attendues (4 groupes $\times$ 10 individus) avec les 
variables $\texttt{dose}$ pour la dose de principae actif administr√©e et $\texttt{concent}$ pour la 
concentration dans le sang d'un certain produit chimique.


On repr√©sente les concentrations dans des bo√Ætes √† moustaches pour les diff√©rents groupes du test clinique.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
boxplot(concent ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(data=data_chemical, mapping=ggplot2::aes(x=dose, y=concent)) +
  ggplot2::geom_boxplot(fill='#F2F2F2') +
  ggplot2::labs(x="Dosage", y="Concentration") +
  ggplot2::scale_x_discrete(
    labels = c("dose25"= "25 mg", "dose50"="50 mg", "dose100"="100 mg", "dose200"="200 mg")
  ) +
  ggplot2::theme_light() 
```
:::

Graphiquement, les variances ne  pr√©sentent pas d‚Äôhomog√©n√©it√© entre les groupes d√©finis par les diff√©rentes modalit√©s de dose, ce qui contredit l‚Äôhypoth√®se d‚Äôhomosc√©dasticit√© requise pour l‚ÄôANOVA.

::: {.callout-note collapse="true"}
### Rappel sur les diagrammes en bo√Æte

La bo√Æte √† moustaches r√©sume seulement quelques indicateurs de position
sur une variable quantitative. Le *package* `ggplot2` repr√©sente les
statistiques ci-dessous :

![](/static/img/boxplot.svg){fig-align="center"}
:::

:::

:::

## Question 2

Effectuer un test d‚Äô√©galit√© de variance de Bartlett (`bartlett.test`) et de Levene
(`leveneTest` dans la librairie `car`) pour confirmer le probl√®me vu pr√©c√©demment.

::: {.content-visible when-meta="is_answer_print_2"}

::: answer

On effectue les deux tests d‚Äô√©galit√© de variance propos√©s.  L‚Äôhypoth√®se nulle ($H_0$) postule que 
les variances intra-groupes sont √©gales pour l‚Äôensemble des modalit√©s.


**Test de Bartlett**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
bartlett.test(concent ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
bartlett.test(concent ~ dose, data = data_chemical)
```
:::

**Test de Levene**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::leveneTest(concent ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::leveneTest(concent ~ dose, data = data_chemical)
```
:::

Les p-valeurs sont bien inf√©rieures √† $0,05$ dans les deux tests effectu√©s. 
On rejette donc l'hypoth√®se nulle. Ils confirment l'analyse graphique que les variances ne sont pas identiques.

:::

:::

## Question 3

On propose de s‚Äôint√©resser √† une transformation logarithmique de la variable $\texttt{concent}$. 
Repr√©senter les bo√Ætes √† moustaches des donn√©es transform√©es. Effectuer des tests 
d‚Äô√©galit√© des variances pour v√©rifier la stabilit√© des variances apr√®s transformation.

::: {.content-visible when-meta="is_answer_print_3"}

::: answer

On reproduit les deux premi√®res questions en s'interessant √† $\ln(\texttt{concent})$.

**Analyse graphique**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
boxplot(log(concent) ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(data=data_chemical, mapping=ggplot2::aes(x=dose, y=log(concent))) +
  ggplot2::geom_boxplot(fill='#F2F2F2') +
  ggplot2::labs(x="Dosage", y="Concentration (log)") +
  ggplot2::scale_x_discrete(
    labels = c("dose25"= "25 mg", "dose50"="50 mg", "dose100"="100 mg", "dose200"="200 mg")
  ) +
  ggplot2::theme_light() 
```
:::

**Test de Bartlett**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
bartlett.test(log(concent) ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
bartlett.test(log(concent) ~ dose, data = data_chemical)
```
:::

**Test de Levene**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::leveneTest(log(concent) ~ dose, data = data_chemical)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::leveneTest(log(concent) ~ dose, data = data_chemical)
```
:::

La transformation appliqu√©e a permis de stabiliser les variances.

:::

:::

## Question 4

R√©aliser l‚Äôanalyse de la variance et tester l‚Äôeffet du dosage sur la concentration en
produit chimique.


::: {.content-visible when-meta="is_answer_print_4"}

::: answer

On pourrait mod√©liser l'effet du dosage sur la concentration en produit chimique comme ceci :

$$
\forall\ i \in [\![1,n]\!], \quad \ln(\texttt{concent}_i)=m+\alpha_1\mathbb{1}_{\texttt{dose}=25mg}+\alpha_2\mathbb{1}_{\texttt{dose}=50mg}+\alpha_3\mathbb{1}_{\texttt{dose}=100mg}+\alpha_4\mathbb{1}_{\texttt{dose}=200mg}+\epsilon_i
$$

Ce mod√®le n‚Äôest pas de plein rang et donc non identifiable car $\mathbb{1}=\mathbb{1}_{\texttt{dose}=25mg}+\mathbb{1}_{\texttt{dose}=50mg}+\mathbb{1}_{\texttt{dose}=100mg}+\mathbb{1}_{\texttt{dose}=200mg}$

Il faut donc imposer une contrainte par exemple $\alpha_1=0$ comme le propose {{< iconify logos:r-lang >}} par d√©faut.

On estime ce mod√®le puis on teste la significativit√© du facteur $\texttt{dose}$ avec la fonction `anova`. L'hypoth√®se nulle $H_0$ est $\alpha_2=\alpha_3=\alpha_4=0$

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
reg <- lm(log(concent) ~ dose, data = data_chemical)
anova(reg)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
reg <- lm(log(concent) ~ dose, data = data_chemical)
anova(reg)
```
:::

La p-valeur du test de Fisher est tr√®s faible. On rejette donc $H_0$ c'est √† dire qu‚Äôil y a au moins une moyenne de $ln(\texttt{concent})$ qui
diff√®re des autres selon le dosage effectu√©.

::: {.callout-note collapse="true"}
### Compl√©ment sur la sortie `anova`

La statistique de test est $F$ telle que 

$$
F = \frac{\frac{S^2_{\textrm{inter}}}{I-1}}{\frac{S^2_{\textrm{intra}}}{n-I}}
$$

avec 

* $n$ le nombre d'observations
* $I$ le nombre de groupes, c'est √† dire de modalit√©s de la variable explicative qualitative
* $\forall\ i \in [\![1,I]\!]$, $n_i$ d√©signe le nombre d'observations dans le groupe $i$ et $\overline{Y_i}$ la moyenne de la variable $Y$ dans le groupe $i$ 
* $S^2_\textrm{inter}$ : la somme des carr√©s inter-modalit√©s 
    $$S^2_\textrm{inter}=\sum\limits_{i=1}^I n_i\left(\overline{Y}_i-\overline{Y}\right)^2$$
* $S^2_\textrm{intra}$ : la somme des carr√©s intra-modalit√©s 
    $$S^2_\textrm{intra}=\sum\limits_{i=1}^I \sum\limits_{j=1}^{n_i} \left(Y_{ij}-\overline{Y_i}\right)^2$$

On retrouve ces quantit√©s dans la sorties de la fonction `anova`.

|`Df` | `Sum Sq`   | `Mean Sq`  | `F value`  | `Pr(>F)`  |
|---|---|---|---|---|
| $I-1$  | $S^2_\textrm{inter}$   | $\frac{S^2_{\textrm{inter}}}{I-1}$  | $F$  |  $1-F_{\mathcal{F}(I-1, \ n-I)}(F)$ |
| $n-I$   | $S^2_\textrm{intra}$  | $\frac{S^2_{\textrm{intra}}}{n-I}$  |   |   |

On pouvait calculer toutes ces valeurs sans utiliser directement la fonction `anova`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
n <- nrow(data_chemical)
I <- length(levels(data_chemical$dose))
Y_bar <- mean(log(data_chemical$concent))
n_i <- sapply(
  X = levels(data_chemical$dose),
     FUN=function(x){sum(data_chemical$dose==x)}
)
Y_i_bar <- sapply(
  X = levels(data_chemical$dose),
  FUN=function(x){sum(as.numeric(data_chemical$dose==x)*log(data_chemical$concent))}
)/n_i
S2_inter <- sum(n_i*(Y_i_bar-rep(Y_bar, I))**2)
S2_intra <- sum((log(data_chemical$concent)-Y_i_bar[data_chemical$dose])**2)
Fstat <- (S2_inter/(I-1))/(S2_intra/(n-I))
pval <- 1-pf(q = Fstat, df1 = I-1, n-I)
cat(paste0("I-1 = ", I-1,"\n"))
cat(paste0("S¬≤inter = ",S2_inter,"\n"))
cat(paste0("S¬≤inter / (I-1) = ",S2_inter/(I-1),"\n"))
cat(paste0("n-I = ", n-I,"\n"))
cat(paste0("S¬≤intra = ",S2_intra,"\n"))
cat(paste0("S¬≤intra / (I-1) = ",S2_intra/(n-I),"\n"))
cat(paste0("F = ",Fstat,"\n"))
cat(paste0("p-value = ",pval,"\n"))

```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
n <- nrow(data_chemical)
I <- length(levels(data_chemical$dose))
Y_bar <- data_chemical |>
  dplyr::pull(concent) |>
  log() |>
  mean()

data_group <- data_chemical |> 
  dplyr::group_by(dose) |>
  dplyr::summarise(
    n_i = dplyr::n(),
    Y_i_bar = mean(log(concent)),
    .group = "drop"
  )
  
S2_inter <- data_group |>
  dplyr::mutate(
    x = n_i*(Y_i_bar-Y_bar)**2
  ) |>
  dplyr::pull(x) |>
  sum()
  
S2_intra <- data_chemical |>
  dplyr::left_join(y=data_group, by = "dose") |>
  dplyr::mutate(
    x = (log(concent)-Y_i_bar)**2
  ) |>
  dplyr::pull(x) |>
  sum()
  
Fstat <- (S2_inter/(I-1))/(S2_intra/(n-I))
pval <- 1-pf(q = Fstat, df1 = I-1, n-I)

cat(paste0("I-1 = ", I-1,"\n"))
cat(paste0("S¬≤inter = ",S2_inter,"\n"))
cat(paste0("S¬≤inter / (I-1) = ",S2_inter/(I-1),"\n"))
cat(paste0("n-I = ", n-I,"\n"))
cat(paste0("S¬≤intra = ",S2_intra,"\n"))
cat(paste0("S¬≤intra / (I-1) = ",S2_intra/(n-I),"\n"))
cat(paste0("F = ",Fstat,"\n"))
cat(paste0("p-value = ",pval,"\n"))
```
:::

:::

:::

:::

## Question 5 

Analyser √† pr√©sent le r√©sum√© de la sortie de la fonction `lm` : √† quoi correspond chaque
quantit√© ?

::: {.content-visible when-meta="is_answer_print_5"}

::: answer

On appelle la fonction `summary` sur l'objet `reg` qui correspond √† l'ajustement de notre mod√®le ANOVA.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
summary(reg)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
summary(reg)
```
:::

Le mod√®le inclut une constante `(Intercept)` ainsi que des variables indicatrices pour les modalit√©s $\texttt{dose50}$, $\texttt{dose100}$ et $\texttt{dose200}$. La modalit√© $\texttt{dose25}$, absente du mod√®le, sert de modalit√© de r√©f√©rence.


L‚Äôinterpr√©tation des coefficients, et donc des tests de Student associ√©s, d√©pend de la contrainte 
qui a √©t√© choisie initialement.

* La constante (3.6151) correspond √† la moyenne dans la modalit√© de r√©f√©rence, c‚Äôest √† dire la moyenne de $\ln(\texttt{concent})$ pour les observations ayant la modalit√© $\texttt{dose25}$. Les r√©sultats du test de Student donn√©s sur cette premi√®re ligne permettent de d√©terminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalit√© $\texttt{dose25}$ est significativement diff√©rente de 0.
* L‚Äôestimation associ√©e √† $\texttt{dose50}$ (1.0072) correspondent √† la diff√©rence entre la moyenne dans la modalit√©
$\texttt{dose50}$ et la moyenne dans la modalit√© $\texttt{dose25}$. Les r√©sultats du test de Student donn√©s sur cette deuxi√®me ligne permettent de d√©terminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalit√© $\texttt{dose50}$ est significativement diff√©rente de celle dans la modalit√© $\texttt{dose25}$.
* L‚Äôestimation associ√©e √† $\texttt{dose100}$ (1.6380) correspondent √† la diff√©rence entre la moyenne dans la modalit√©
$\texttt{dose100}$ et la moyenne dans la modalit√© $\texttt{dose25}$. Les r√©sultats du test de Student donn√©s sur cette troisi√®me ligne permettent de d√©terminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalit√© $\texttt{dose100}$ est significativement diff√©rente de celle dans la modalit√© $\texttt{dose25}$.
* L‚Äôestimation associ√©e √† $\texttt{dose200}$ (1.9945) correspondent √† la diff√©rence entre la moyenne dans la modalit√©
$\texttt{dose200}$ et la moyenne dans la modalit√© $\texttt{dose25}$. Les r√©sultats du test de Student donn√©s sur cette quatri√®me ligne permettent de d√©terminer ici si la moyenne de $\ln(\texttt{concent})$ dans la modalit√© $\texttt{dose200}$ est significativement diff√©rente de celle dans la modalit√© $\texttt{dose25}$.

Tous ces tests de Student concluent que les coeffcients sont significatifs sont significatifs.

:::

:::

## Question 6

D‚Äôapr√®s la sortie pr√©c√©dente, quelles moyennes semblent diff√©rer des autres ? Effectuer
un test de Tukey pour identifier les diff√©rences significatives (si le mod√®le se nomme 
`reg` on peut lancer l'instruction `TukeyHSD(aov(reg))`) et repr√©senter les intervalles de confiance associ√©s (`plot`
du r√©sultat).


::: {.content-visible when-meta="is_answer_print_6"}

::: answer

La sortie comment√©e √† la question pr√©c√©dente indique que la modalit√© $\texttt{dose25}$ pr√©sente une moyenne de $\ln(\texttt{concent})$ significativement inf√©rieure √† celle des autres dosages, avec une diff√©rence de l'ordre de 1 √† 2 unit√©s. Cependant, la comparaison entre les autres dosages est moins √©vidente. Bien qu'une tendance √† l'augmentation de $\ln(\texttt{concent})$ avec le dosage soit observ√©e, il n'est pas clair si cette augmentation est significative, notamment entre les modalit√©s $\texttt{dose100}$ et $\texttt{dose200}$.

Pour r√©soudre cette incertitude, le test de Tukey est appliqu√©. Ce test permet de comparer les moyennes deux √† deux tout en garantissant un niveau de confiance simultan√© de 5 % (ou tout autre seuil choisi). En outre, le test de Tukey fournit des intervalles de confiance (IC) simultan√©s √† 95 %, ce qui signifie que la probabilit√© que toutes les diff√©rences de moyennes appartiennent √† ces intervalles est de 95 %.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
TukeyHSD(aov(reg))
par(mar = c(5, 8, 4, 2) + 0.1)
plot(TukeyHSD(aov(reg)), las = 1)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
# Mise en oeuvre du test de Tukey
tukey <- TukeyHSD(aov(reg))

# G√©n√©ration de la sortie graphique
tukey_df <- as.data.frame(tukey$dose)
tukey_df <- tukey_df |>
  dplyr::mutate(comparison = rownames(tukey_df))

ggplot2::ggplot(tukey_df, ggplot2::aes(x = comparison, y = diff)) +
  ggplot2::geom_point(size = 3) +
  ggplot2::geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  ggplot2::geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  ggplot2::coord_flip() +
  ggplot2::theme_minimal() +
  ggplot2::labs(
    title = "Test de Tukey",
    x = "Comparaison de groupes",
    y = "Diff√©rence des moyennes (IC √† 95 %)"
  )
```
:::

En analysant les p-values des tests ainsi que les intervalles de confiance (IC), on observe que la derni√®re diff√©rence n'est pas significativement diff√©rente de 0. Cela indique un gain significatif lors de l'augmentation du dosage jusqu'√† 100, mais un effet seuil semble appara√Ætre, car le gain n'est plus significatif lorsque l'on passe de 100 √† 200.

:::

:::
