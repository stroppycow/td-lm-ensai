---
title: "TD 6 - Exercice 5 - Sant√© mentale"
lang: fr
author: "Th√©o Leroy"
date: "5 decembre 2025"
params:
  question_courante: 0
format:
  live-html:
    code-background: true
    toc: true
    page-layout: full
webr:
  render-df: gt-interactive
  resources:
    - ./../data/Mental.txt
  packages:
      - dplyr
      - readr
      - ggplot2
      - tidyr
      - VGAM
editor: 
  mode: source
  markdown: 
    wrap: 72
fig-align: center
filters: 
  - custom-callout
custom-callout:    
  answer:
    color: "#CCCCCC"
    icon: true
    icon-symbol: "üìù"
    appearance: "default"
    title: "Correction"
---

{{< include ./../_extensions/conditionnal.qmd >}}
{{< include ./../_extensions/r-wasm/live/_knitr.qmd >}}

On consid√®re les donn√©es `mental`, contenues dans le fichier
`Mental.txt`. Ce jeu de donn√©es, de taille $n = 40$,
est extrait d‚Äôune √©tude sur la sant√© mentale d‚Äôadultes vivant dans le comt√© am√©ricain
d‚ÄôAlachua, en Floride. Il contient trois variables :

- Une variable $\texttt{impair}$ d√©crivant l‚Äô√©tat mental de la personne concern√©e, de 1 (sain) √†
4 (en mauvaise sant√©),
- Une variable $\texttt{ses}$ qui vaut 1 si la personne a un statut socio-√©conomique √©lev√©, 0
sinon,
- Une variable $\texttt{life}$ mesurant le nombre et l‚Äôintensit√© des bouleversements qu‚Äôa connus
la personne au cours des trois derni√®res ann√©es, de 0 (aucun changement) √† 9
(changements tr√®s importants).


Le but de l‚Äôexercice est de mod√©liser la variable $\texttt{imapir}$.

## Question 1

Importer les donn√©es sous {{< iconify logos:r-lang >}}. La variable $\texttt{ses}$
est-elle qualitative ou quantitative ?
M√™me question pour la variable $\texttt{life}$.
Changer leur classe sous {{< iconify logos:r-lang >}} si besoin.

::: {.content-visible when-meta="is_answer_print_1"}

::: answer

Importons le fichier de donn√©es `Mental.txt` en {{< iconify logos:r-lang >}} sous forme de
`data.frame`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
data_mental <- read.csv(
  file = 'data/Mental.txt',
  sep = " ",
  header = TRUE,
  colClasses = c("factor", "integer", "integer")
)
data_mental$impair <- as.ordered(data_mental$impair)
data_mental
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_mental <- readr::read_delim(
  file = "data/Mental.txt",
  col_types = readr::cols(
    readr::col_factor(levels = c("1", "2", "3", "4"), ordered = TRUE),
    readr::col_integer(),
    readr::col_integer()
  ),
  delim = " "
)
data_mental
```
:::

La variable $\texttt{ses}$ (statut socio-√©conomique) est qualitative. On peut la
charger comme `factor` ou comme `integer` car cette variable ne comporte
que deux modalit√©s.

√Ä l'inverse, on peut voir la variable $\texttt{life}$comme quantitative. On
suppose que l'accroissement d'une unit√© de cette variable a du sens et
correspond √† une augmentation de la fr√©quence d'√©v√®nements troublants
pour un individu. Consid√©rer la variable $\texttt{life}$ comme qualitative ne
serait pas une erreur mais ferait exploser le nombre de regresseurs dans
la mod√©lisation alors qu'il n'y a que 40 observations.

:::

:::

## Question 2

Effectuer une petite √©tude descriptive pour identifier un lien √©ventuel entre la variable
$\texttt{imapir}$ et les autres variables du jeu de donn√©es.

::: {.content-visible when-meta="is_answer_print_2"}

::: answer

**Lien entre $\texttt{ses}$ et $\texttt{impair}$**

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
# Cr√©ation d'une table de contingence pour les proportions
prop_data <- as.data.frame(prop.table(table(data_mental$impair, data_mental$ses), margin = 1))
names(prop_data) <- c("impair", "ses", "proportion")

# Cr√©ation des barres empil√©es avec proportions
barplot_data <- table(data_mental$impair, data_mental$ses)

barplot(
  height = t(prop.table(barplot_data, margin = 1)), # Calcul des proportions par groupe
  beside = FALSE, # Empil√©
  col = c("#949FA6", "#F24B4B"), # Couleurs
  xlab = "Proportion", 
  ylab = "√âtat mental",
  horiz = TRUE, # Orientation horizontale
  legend.text = c("Faible", "√âlev√©"), # L√©gende
  args.legend = list(x = "bottom", inset = 0.05, title = "Statut socio-√©conomique") # Position de la l√©gende
)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(
  data = data_mental,
  mapping = ggplot2::aes(y = impair, fill = as.factor(ses), by = impair)
) +
  ggplot2::geom_bar(position = "fill") +
  ggplot2::geom_text(
    mapping = ggplot2::aes(label = after_stat(count)),
    stat = "count",
    position = position_fill(vjust = 0.5)
  ) +
  ggplot2::labs(x = "Proportion", y = "√âtat mental") +
  ggplot2::scale_fill_manual(
    values = c("1"="#F24B4B", "0"="#949FA6"),
    labels = c("1"="√âlev√©", "0"="Faible"),
    name = "Statut socio-√©conomique"
  ) +
  ggplot2::theme_light() +
  ggplot2::theme(legend.position = "bottom")
```
:::

**Lien entre $\texttt{life}$ et $\texttt{impair}$**

::: {.panel-tabset group="language"}
#### Base R

```{webr}
#| envir: baser
#| autorun: true
boxplot(
  life ~ impair, 
  data = data_mental, 
  col = "#F2F2F2", 
  xlab = "√âtat mental", 
  ylab = "Score de troubles v√©cus life", 
  border = "black"
)
```

#### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
ggplot2::ggplot(
  data = data_mental,
  mapping = ggplot2::aes(x = impair, y = life, group = impair)
) +
  ggplot2::geom_boxplot(fill = "#F2F2F2") +
  ggplot2::labs(x = "√âtat mental", y = "Score de troubles v√©cus life") +
  ggplot2::scale_x_discrete(
    labels = c(
      "1"="Sain",
      "2"="Plut√¥t sain",
      "3"="Plut√¥t en mauvaise sant√©",
      "4"="En mauvaise sant√©"
      )
  ) +
  ggplot2::theme_light() 
```
:::

Ce graphique illustre une relation empirique positive entre les
variables $\texttt{life}$ et $\texttt{impair}$. Plus la fr√©quence et l'intensit√© des
bouleversements v√©cus sont importants et plus les personnes sont dans
une situation de mauvaise sant√© mentale.

:::

:::

## Question 3
Pour commencer, on d√©cide d‚Äôignorer le fait que la variable impair est ordinale et de la
mod√©liser par un mod√®le logistique multinomial (sans interaction entre les variables).
Ecrire math√©matiquement ce mod√®le. Combien a-t-il de coefficients √† estimer ?

::: {.content-visible when-meta="is_answer_print_3"}

::: answer

Le mod√®le de r√©gression logistique multinomial s'√©crit :

$$
\begin{align*}
\texttt{impair}&|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}) \sim \mathcal{M}( \\
&n=1, \\
&1-\sum\limits_{k=2}^4\mathbb{P}(\texttt{impair}= k|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}= 2|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}= 3|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}= 4|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))) \\
\end{align*}
$$
On estime les rapports en prennant une des modalit√©s comme r√©f√©rence (par d√©faut, {{< iconify logos:r-lang >}} choisit la premi√®re dans c'est √† dire la modalit√© 1):

$$
\forall \ k \in \{2, \ 3,\ 4 \}, \ \ln\left(\frac{\mathbb{P}(\texttt{impair}= k|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))}{\mathbb{P}(\texttt{impair}= 1|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))}\right)=\beta_0^{(k)}+\beta_1x_{\texttt{ses}}+\beta_2x_\texttt{life}
$$

On estime donc 9 coefficients (3 par rapport).

:::

:::


## Question 4

Estimer ce mod√®le √† l‚Äôaide de la fonction `vglm` du package `VGAM`, en choisissant comme
modalit√© de r√©f√©rence `impair=1`, et s√©lectionner le meilleur sous-mod√®le possible.

::: {.content-visible when-meta="is_answer_print_4"}

::: answer

Nous allons estimer ce mod√®le, toutefois, les fonctionnalit√©s {{< iconify logos:r-lang >}}
de base ne permettent pas d'estimer ce mod√®le directement avec une fontion comme
`lm` ou `glm`. Le cours nous invite, par exemple, √† utiliser le package
`VGAM` et la fonction `vglm` en son sein.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q4_full <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ life + ses,
  family = multinomial(refLevel="1"),
  data = data_mental
)
summary(modele_q4_full)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q4_full <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ life + ses,
  family = multinomial(refLevel="1"),
  data = data_mental
)
summary(modele_q4_full)
```
:::

On retrouve bien les 9 coefficients attendus. √Ä premi√®re vue, la variable `ses` (statut socio-√©conomique) ne semble pas significative.

On estime les sous mod√®les possibles :

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q4_ses <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ ses,
  family = multinomial(refLevel="1"),
  data = data_mental
)
modele_q4_life <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ life,
  family = multinomial(refLevel="1"),
  data = data_mental
)
modele_q4_const <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ 1,
  family = multinomial(refLevel="1"),
  data = data_mental
)

data.frame(
  `Mod√®le`=c("Avec impair et ses", "Avec ses uniquement", "Avec life uniquement", "Mod√®le nul"),
  AIC = sapply(X=c(modele_q4_full, modele_q4_ses, modele_q4_life, modele_q4_const), FUN = AIC),
  BIC = sapply(X=c(modele_q4_full, modele_q4_ses, modele_q4_life, modele_q4_const), FUN = BIC)
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q4_ses <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ ses,
  family = multinomial(refLevel="1"),
  data = data_mental
)
modele_q4_life <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ life,
  family = multinomial(refLevel="1"),
  data = data_mental
)
modele_q4_const <- VGAM::vglm(
  formula = factor(impair, ordered = FALSE) ~ 1,
  family = multinomial(refLevel="1"),
  data = data_mental
)

data.frame(
  `Mod√®le`=c("Avec impair et ses", "Avec ses uniquement", "Avec life uniquement", "Mod√®le nul"),
  AIC = sapply(X=c(modele_q4_full, modele_q4_ses, modele_q4_life, modele_q4_const), FUN = AIC),
  BIC = sapply(X=c(modele_q4_full, modele_q4_ses, modele_q4_life, modele_q4_const), FUN = BIC)
)
```
:::

:::

:::


## Question 5

On souhaite √† pr√©sent exploiter le fait que la variable impair est ordonn√©e. √âcrire math√©matiquement le mod√®le de r√©gression logistique cumulatif proportionnel
sans terme d‚Äôinteraction liant $\texttt{impair}$ √† $\texttt{ses}$ et $\texttt{life}$,
et permettant d‚Äôestimer les probabilit√©s que
$\texttt{impair} = 1, \ \texttt{impair} \leq 2$ et $\texttt{impair} \leq 3$.
Combien ce mod√®le a-t-il de coefficients ?

::: {.content-visible when-meta="is_answer_print_5"}

::: answer

La loi d√©crivant l'√©tat mental d'un individu conditionnellement √† son
statut √©conomique ($\texttt{ses}$) et le nombre et l'intensit√© des
bouleversements qu'il a connu au cours des trois derni√®res ann√©es
($\texttt{life}$) est une loi de multinomiale.

Le mod√®le de r√©gression logistique cumulatif avec structure
proportionnelle s'√©crit :

$$
\begin{align*}
\texttt{impair}&|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}) \sim \mathcal{M}( \\
&n=1, \\
&\mathbb{P}(\texttt{impair}\leq 1|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}\leq 2|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))-\mathbb{P}(\texttt{impair}\leq 1|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}\leq 3|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))-\mathbb{P}(\texttt{impair}\leq 2|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&1 - \mathbb{P}(\texttt{impair}\leq 3|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))) \\
\end{align*}
$$

avec

$$
\forall\ k \in \{1,2,3\}, \ \textrm{logit}\left(\mathbb{P}(\texttt{impair}\leq k | (\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))\right) = \beta_0^{(k)}+\beta_1x_{\texttt{ses}}+\beta_2x_\texttt{life}
$$

Il y a 5 param√®tres √† estimer : $\beta_0^{(1)}$, $\beta_0^{(2)}$,
$\beta_0^{(3)}$, $\beta_1$ et $\beta_2$.

:::

:::

## Question 6

Estimer les coefficients de ce mod√®le √† l‚Äôaide de la fonction `vglm` du package
`VGAM`, associ√©e √† l‚Äôoption `family=cumulative(parallel=TRUE)`. Contr√¥ler que
le nombre de coefficients est bien celui attendu.

::: {.content-visible when-meta="is_answer_print_6"}

::: answer

Nous allons estimer ce mod√®le avec `vglm` du package `VGAM`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q6 <- VGAM::vglm(
  formula = impair ~ ses + life,
  family = cumulative(parallel = TRUE),
  data = data_mental
)
summary(modele_q6)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q6 <- VGAM::vglm(
  formula = impair ~ ses + life,
  family = cumulative(parallel = TRUE),
  data = data_mental
)
summary(modele_q6)
```
:::

On peut lire les valeurs des 5 coefficients attendus dans la colonne
`Estimate` (3 pour les constantes de chaque probabilit√© cumul√©e et 2
associ√©es √† chaque r√©gresseur).

:::

:::

## Question 7

Y a-t-il une influence du statut socio-√©conomique sur l‚Äô√©tat de sant√© mentale au seuil
5¬†%¬†? Et au seuil 10¬†%¬†?

::: {.content-visible when-meta="is_answer_print_7"}

::: answer

D'apr√®s la sortie obtenue √† la [question 6](#question-6) et les p-valeur
des tests de Wald, le coefficient $\beta_1$ est non significatif au
seuil d'erreur 5¬†% mais il est significatif au seuil 10¬†%.

Toutefois, l'effectif relativement faible (40 personnes), ce qui limite la puissance statistique des tests. En d‚Äôautres termes, l‚Äôabsence de significativit√© pourrait simplement provenir d‚Äôun manque de donn√©es. Sur le plan m√©dical, on ne peut donc pas √©carter totalement l‚Äô√©ventuelle influence de cette variable sur l‚Äô√©tat de sant√© mentale.

:::

:::

## Question 8

Peut-on proposer un mod√®le plus simple¬†?

::: {.content-visible when-meta="is_answer_print_8"}

::: answer

Au vu de la question pr√©c√©dente, on peut essayer de retirer la variable $\texttt{ses}$ :

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q8 <- VGAM::vglm(
  formula = impair ~ life,
  family = cumulative(parallel = TRUE),
  data = data_mental
)
summary(modele_q8)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q8 <- VGAM::vglm(
  formula = impair ~ life,
  family = cumulative(parallel = TRUE),
  data = data_mental
)
summary(modele_q8)
```
:::

On peut faire un test de rapport de vraisemblance comparant ce mod√®le au mod√®le avec la variable $\texttt{ses}$.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(modele_q8, modele_q6, type = "I")
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(modele_q8, modele_q6, type = "I")
```
:::

Au seuil de 5¬†%, on est donc amen√© √† privil√©gier ce mod√®le plus simple.

Cependant, compte tenu de la p-value proche du seuil et du faible effectif de l‚Äô√©tude, ce choix peut √™tre questionn√©.

:::

:::


## Question 9

On souhaite v√©rifier que le mod√®le √† odds proportionnel est ad√©quat par rapport
au mod√®le de r√©gression logistique cumulatif (sans interaction). √âcrire l‚Äôexpression
math√©matique de ce mod√®le, l‚Äôestimer et comparer au mod√®le √† odds proportionnel.

::: {.content-visible when-meta="is_answer_print_9"}

::: answer

Le mod√®le de r√©gression logistique cumulatif sans structure
proportionnelle et sans terme d'int√©raction s'√©crit :

$$
\begin{align*}
\texttt{impair}&|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}) \sim \mathcal{M}( \\
&n=1, \\
&\mathbb{P}(\texttt{impair}\leq 1|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}\leq 2|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))-\mathbb{P}(\texttt{impair}\leq 1|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&\mathbb{P}(\texttt{impair}\leq 3|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))-\mathbb{P}(\texttt{impair}\leq 2|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life})), \\
&1 - \mathbb{P}(\texttt{impair}\leq 3|(\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))) \\
\end{align*}
$$

avec pour tout $k \in \{1,2,3\}$

$$
 \textrm{logit}\left(\mathbb{P}(\texttt{impair}\leq k | (\texttt{ses}=x_\texttt{ses},\texttt{life}=x_\texttt{life}))\right) = \gamma_0^{(k)}+\gamma_1^{(k)}x_{\texttt{ses}}+\gamma_2^{(k)}x_\texttt{life}
$$

Il y a 9 param√®tres √† estimer : $\gamma_0^{(1)}$, $\gamma_0^{(2)}$,
$\gamma_0^{(3)}$, $\gamma_1^{(1)}$, $\gamma_1^{(2)}$, $\gamma_1^{(3)}$,
$\gamma_2^{(1)}$, $\gamma_2^{(2)}$ et $\gamma_2^{(3)}$.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q9<- VGAM::vglm(
  formula = impair ~ ses + life,
  family = cumulative(parallel = FALSE),
  data = data_mental
)
summary(modele_q9)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q9 <- VGAM::vglm(
  formula = impair ~ ses + life,
  family = cumulative(parallel = FALSE),
  data = data_mental
)
summary(modele_q9)
```
:::

√Ä l'image de la [question 8](#question-8), on peut faire un test du
rapport de vraisemblance entre ces deux mod√®les emboit√©s.

L'hypoth√®se nulle est
$H_0: \gamma_1^{(1)}=\gamma_1^{(2)}=\gamma_1^{(3)}$ et
$\gamma_2^{(1)}=\gamma_2^{(2)}=\gamma_2^{(3)}$.

Les valeurs de la statistique de test et le quantile de comparaison sont
:

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
summary(modele_q6)@criterion$deviance - summary(modele_q9)@criterion$deviance
qchisq(0.95,4)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
summary(modele_q6)@criterion$deviance - summary(modele_q9)@criterion$deviance
qchisq(0.95,4)
```
:::

Quatre coefficients sont contraints dans le mod√®le avec structure
proportionnelle.

On ne rejette pas $H_0$ car la statistique de test est inf√©rieure au
quantile $q_{0.95}^{\chi^2(4)}$.

Ainsi, le mod√®le avec la structure non proportionnelle n'est pas
significativement meilleur.

::: {.callout-note collapse="true"}
### Alternative avec la fonction `anova`

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
anova(modele_q6, modele_q9, type = "I")
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
anova(modele_q6, modele_q9, type = "I")
```
:::


:::

:::

:::


## Question 10

Conclure sur la mod√©lisation de la variable $\texttt{impair}$.


::: {.content-visible when-meta="is_answer_print_10"}

::: answer


Le mod√®le √† odds proportionnels est le plus simple et se r√©v√®le pr√©f√©rable au mod√®le cumulatif (voir question pr√©c√©dente).

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
AIC(modele_q6)
AIC(modele_q9)
BIC(modele_q6)
BIC(modele_q9)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
AIC(modele_q6)
AIC(modele_q9)
BIC(modele_q6)
BIC(modele_q9)
```
:::

Les crit√®res AIC et BIC confirment √©galement qu‚Äôil est sup√©rieur au mod√®le multinomial. Nous retenons donc ce mod√®le pour expliquer $\texttt{impair}$.

Reste √† d√©cider s‚Äôil faut inclure la variable ses dans l‚Äôanalyse, d√©cision pour laquelle une expertise m√©tier serait pr√©cieuse.

:::

:::
