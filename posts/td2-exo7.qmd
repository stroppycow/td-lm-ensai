---
title: "TD 2 - Exercice 7 - Mod√©lisation de la concentration maximale journali√®re en ozone"
lang: fr
author: "Th√©o Leroy"
date: "10 octobre 2025"
params:
  question_courante: 10
format:
  live-html:
    code-background: true
    toc: true
    page-layout: full
webr:
  render-df: gt-interactive
  resources:
    - ./../data/ozone.txt
  packages:
      - dplyr
      - readr
      - ggplot2
      - cowplot
      - GGally
      - car
      - leaps
      - lmtest
editor: 
  mode: source
  markdown: 
    wrap: 72
fig-align: center
filters: 
  - diagram
  - custom-callout
custom-callout:    
  answer:
    color: "#CCCCCC"
    icon: true
    icon-symbol: "üìù"
    appearance: "default"
    title: "Correction"
    
---

{{< include ./../_extensions/conditionnal.qmd >}}
{{< include ./../_extensions/r-wasm/live/_knitr.qmd >}}

Le jeu de donn√©es `ozone.txt` contient la concentration maximale d‚Äôozone ($\texttt{maxO3}$)
mesur√©e chaque jour de l‚Äô√©t√© 2001 √† Rennes. Il contient √©galement les temp√©ratures, la n√©bulosit√© et la vitesse du vent mesur√©s √† 9h, 12h et 15h (respectivement $\texttt{T9}$, $\texttt{T12}$, $\texttt{T15}$, $\texttt{Ne9}$, $\texttt{Ne12}$, $\texttt{Ne15}$ et $\texttt{Vx9}$, $\texttt{Vx12}$, $\texttt{Vx15}$), ainsi que la direction principale du vent et la pr√©sence ou non de pluie. On d√©sire expliquer au mieux la concentration d‚Äôozone √† l‚Äôaide des variables disponibles dans le jeu de donn√©es.

## Question 1

Analyser le nuage de points et la corr√©lation lin√©aire entre $\texttt{maxO3}$ et chacune des variables quantitatives disponibles (c‚Äôest √† dire $\texttt{T9}$, $\texttt{T12}$, $\texttt{T15}$, $\texttt{Ne9}$, $\texttt{Ne12}$, $\texttt{Ne15}$, $\texttt{Vx9}$, $\texttt{Vx12}$ et $\texttt{Vx15}$). Est-il raisonnable de supposer qu‚Äôil existe un lien lin√©aire entre $\texttt{maxO3}$ et ces variables ?

::: {.content-visible when-meta="is_answer_print_1"}

::: answer

On charge les donn√©es du fichier `ozone.txt` en {{< iconify logos:r-lang >}} sous forme de `data.frame`.

::: {.panel-tabset group="language"}

### Base R

```{webr}
#| envir: baser
#| autorun: true
data_ozone <- read.csv(
  file = "data/ozone.txt",
  header = TRUE,
  sep = " ",
  quote = '"'
)
data_ozone
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_ozone <- readr::read_delim(
  file = "data/ozone.txt",
  col_types = "_cnnnnnnnnnncc",
  col_names = c(
    "date","maxO3","T9","T12","T15","Ne9","Ne12","Ne15",
    "Vx9","Vx12","Vx15","vent","pluie"
  ),
  skip = 1,
  delim = " ",
  quote = '"'
)
data_ozone
```

:::

Le fichier charg√© contient bien 122 observations avec les variables
$\texttt{maxO3}$ pour la concentration maximale d‚Äôozone mesur√©e chaque jour
(exprim√©e en m√®tre), $\texttt{T9}$, $\texttt{T12}$, $\texttt{T15}$ pour les temp√©ratures, $\texttt{Ne9}$, $\texttt{Ne12}$, $\texttt{Ne15}$ pour les n√©bulosit√©s et $\texttt{Vx9}$, $\texttt{Vx12}$ et $\texttt{Vx15}$ pour la
vitesse du vent.

On repr√©sente ces donn√©es dans des plans ou l'axe des ordonn√©es est
toujours $\texttt{maxO3}$ : la variable √† expliquer.

::: {.panel-tabset group="language"}

### Base R

```{webr}
#| envir: baser
#| autorun: true
#| fig-align: center
#| fig-height: 8
par(mfrow = c(3,3), mar = c(4,4,1,1))
lapply(
  X = c("T9", "T12", "T15", "Ne9", "Ne12", "Ne15", "Vx9", "Vx12", "Vx15"),
  FUN = function(nom_var_x){
    plot(
      x = data_ozone[[nom_var_x]],
      y = data_ozone[["maxO3"]],
      type ="p",
      xlab = nom_var_x,
      ylab = "maxO3",
      pch = 3
    )
    grid()
  }
) |> invisible()
cor(
  x = data_ozone$maxO3,
  y = data_ozone[,c("T9", "T12", "T15", "Ne9", "Ne12", "Ne15", "Vx9", "Vx12", "Vx15")],
  use = "complete.obs"
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
#| fig-align: center
#| fig-height: 8
plots <- lapply(
  X = c("T9", "T12", "T15", "Ne9", "Ne12", "Ne15", "Vx9", "Vx12", "Vx15"),
  FUN = function(nom_var_x){
   ggplot2::ggplot(
      data = data_ozone,
      mapping = ggplot2::aes(x = .data[[nom_var_x]], y = maxO3)
    ) +
    ggplot2::labs(x = nom_var_x, y = "maxO3") + 
    ggplot2::geom_point(na.rm = TRUE)
  }
) 
cowplot::plot_grid(plotlist = plots)
```

:::


On observe une relation lin√©aire croissante assez prononc√©e avec $\texttt{T9}$, $\texttt{T12}$ et $\texttt{T15}$, une l√©g√®re relation d√©croissante avec $\texttt{Ne9}$, $\texttt{Ne12}$ et $\texttt{Ne15}$, ainsi qu'une faible relation lin√©aire avec $\texttt{Vx9}$, $\texttt{Vx12}$ et $\texttt{Vx15}$. Aucun lien non-lin√©aire ne semble ressortir de mani√®re √©vidente.

:::

:::

## Question 2 {#question-2}

Ajuster le mod√®le de r√©gression lin√©aire expliquant $\texttt{maxO3}$ en fonction de toutes les
variables quantitatives pr√©c√©dentes. Tester la significativit√© de chacune des variables
explicatives dans ce mod√®le. Le r√©sultat est-il en accord avec les observations de la
question pr√©c√©dente ? Tester √©galement la significativit√© globale du mod√®le. Commenter.

::: {.content-visible when-meta="is_answer_print_2"}

::: answer

On effectue la r√©gression
$$\texttt{maxO3}_i = \beta_1+\beta_2\texttt{T9}_i+\beta_3\texttt{T12}_i+\beta_4\texttt{T15}_i+\beta_5\texttt{Ne9}_i+\beta_6\texttt{Ne12}_i+\beta_7\texttt{Ne15}_i+\beta_8\texttt{Vx9}_i+\beta_9\texttt{Vx12}_i+\beta_{10}\texttt{Vx15}_i+\varepsilon_i$$
√† l'aide de la fonction `lm` disponible nativement dans
{{< iconify logos:r-lang >}}. On cherche ainsi une estimation du vecteur
$\beta$ √† l'aide de la m√©thode des moindres carr√©s ordinaires (MCO).

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q2 <- lm(
  maxO3 ~ T9 + T12 + T15 + Ne9 + Ne12 + Ne15 + Vx9 + Vx12 + Vx15,
  data = data_ozone
)
summary(modele_q2)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q2 <- lm(
  maxO3 ~ T9 + T12 + T15 + Ne9 + Ne12 + Ne15 + Vx9 + Vx12 + Vx15,
  data = data_ozone
)
summary(modele_q2)
```
:::

Les r√©sultats de cette estimations sont assez peut coh√©rents avec les
intuitions de la question 1. Selon le test de significativit√© de
Student, aucune variable ne semble significative dans ce mod√®le, √†
l'exception peut-√™tre de $\texttt{Vx9}$ au seuil $\alpha =0,05$. Ces r√©sultats
sont assez surprenants, surtout compte tenu des nuages de points
observ√©s pr√©c√©demment. En particulier, $\texttt{Vx9}$` ne semblait pas √™tre la
variable la plus pertinente pour expliquer $\texttt{maxO3}$.

Par ailleurs le test de significativit√© globale de Fisher (derni√®re
ligne de la sortie) donne une p-value bien inf√©rieure √† $0,05$ donc on
rejette l'hypoth√®se nulle $H_0: \ \beta_2 = \dots =  \beta_{10}=0$. Cette
issue du test de Fisher semble √©galement entrer en contradiction avec
les tests de Student pr√©c√©dents.

Le ph√©nom√®ne observ√© est d√ª au probl√®me de multicolin√©arit√© : certaines
variables explicatives sont tr√®s corr√©l√©es, on peut l'observer
graphiquement.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
pairs(
  x = data_ozone[,c("T9", "T12", "T15")],
  main = "Matrice des nuages de points sur les temp√©ratures"
)

pairs(
  x = data_ozone[,c("Ne9", "Ne12", "Ne15")],
  main = "Matrice des nuages de points sur les n√©buloist√©s"
)

pairs(
  x = data_ozone[,c("Vx9", "Vx12", "Vx15")],
  main = "Matrice des nuages de points sur les vitesses du vent"
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
#| timelimit: 60
GGally::ggpairs(
    data = {data_ozone |> dplyr::filter(!is.na(T9) & !is.na(T12) & !is.na(T15))},
    columns  = c("T9", "T12", "T15"),
    title = "Matrice des nuages de points sur les temp√©ratures",
    upper = list(continuous = "cor"),
    diag = NULL
)
GGally::ggpairs(
    data = {data_ozone |> dplyr::filter(!is.na(Ne9) & !is.na(Ne12) & !is.na(Ne15))},
    columns  = c("Ne9", "Ne12", "Ne15"),
    title = "Matrice des nuages de points sur les n√©buloist√©s",
    upper = list(continuous = "cor"),
    diag = NULL
)
GGally::ggpairs(
    data = {data_ozone |> dplyr::filter(!is.na(Vx9) & !is.na(Vx12) & !is.na(Vx15))},
    columns  = c("Vx9", "Vx12", "Vx15"),
    title = "Matrice des nuages de points sur les vitesses du vent",
    upper = list(continuous = "cor"),
    diag = NULL
)
```
:::

Comme la multicolin√©arit√© n'est pas parfaite $X^{\prime} X$, reste
inversible mais a une inverse qui prend de tr√®s grandes valeurs. La
cons√©quence est que la variance des estimateurs est tr√®s grande (puisque
$\mathbb{V}(\hat{\beta})=\sigma^2\left(X^{\prime} X\right)^{-1}$ ).
Autrement dit, il y a une grande incertitude concernant l'estimation de
chaque coefficient. Ainsi lors du test de Student, l'hypoth√®se
$H_0: \beta_j=0$ est plausible et n'est pas rejet√©e. Il faut donc r√©gler
ce probl√®me de multicolin√©arit√©.


:::

:::

## Question 3

Calculer les VIF (Variance Inflation Factor) pour chacune des variables explicatives
du mod√®le pr√©c√©dent. En quoi ces valeurs expliquent les r√©sultats des tests de Student
effectu√©s ci-dessus ?

::: {.content-visible when-meta="is_answer_print_3"}

::: answer

On peut d√©tecter cette multicolin√©arit√© √† l'aide du VIF (Variance
Inflation Factor) pour chacune des variables explicatives du mod√®le
pr√©c√©dent.

Le VIF pour la variable $X^{(j)}$ vaut 

$$
VIF_j=\frac{1}{1-R_j^2}
$$

o√π $R_j^2$ est le $R^2$ dans la r√©gression de $X^{(j)}$ par rapport
aux autres variables explicatives

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
car::vif(modele_q2)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
#| timelimit: 60
car::vif(modele_q2)
```
:::

Certaines valeurs sont √©lev√©es (un premier seuil d‚Äôalerte est
g√©n√©ralement 5), ce qui confirme qu‚Äôil y a un probl√®me de
multicolin√©arit√© entre certaines variables et donc que les tests de
Student ne sont pas rejet√©s.

:::

:::


## Question 4

On d√©cide d‚Äôenlever des variables au mod√®le pr√©c√©dent. Quelles variables semblet-il naturel d‚Äôenlever au vu de la question pr√©c√©dente ? Ajuster le nouveau mod√®le propos√© et r√©p√©ter les analyses effectu√©es dans les deux questions pr√©c√©dentes.

::: {.content-visible when-meta="is_answer_print_4"}

::: answer

On peut retenir, une variable parmi chaque groupe (temp√©rature,
n√©bulosit√© et vitesse du vente). On peut s√©lectionner par exemple celle
qui est le plus correl√©e avec la variable $\texttt{maxO3}$ √† chaque fois.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
cor(data_ozone[,
  c("maxO3", "T9", "T12", "T15", "Ne9", "Ne12", "Ne15", "Vx9", "Vx12", "Vx15")
], use = "complete.obs")
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
#| timelimit: 60
data_ozone |>
  dplyr::select(maxO3, T9, T12, T15, Ne9, Ne12, Ne15, Vx9, Vx12, Vx15) |>
  cor(use = "complete.obs")
```
:::

On retient alors $\texttt{T12}$, $\texttt{Ne12}$ et $\texttt{Vx9}$.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: baser
#| autorun: true
modele_q4 <- lm(
  maxO3 ~ T12 + Ne12 + Vx9,
  data = data_ozone
)
summary(modele_q4)
car::vif(modele_q4)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
#| timelimit: 60
modele_q4 <- lm(
  maxO3 ~ T12 + Ne12 + Vx9,
  data = data_ozone
)
summary(modele_q4)
car::vif(modele_q4)
```
:::

Pour commencer, l'analyse des VIF montre que ce mod√®le n'est plus
affect√© par la multicolin√©arit√©. En outre, les variables s√©lectionn√©es
sont significatives, √† l'exception de $\texttt{Ne12}$, qui est √† la limite. Il
serait possible d'affiner davantage le mod√®le, mais il est pertinent de
comparer les valeurs de $R^2$ et $R_a^2$ avec celles du mod√®le global
pr√©sent√© pr√©c√©demment. Comme attendu, le $R^2$ est plus faible, car il
tend √† diminuer lorsqu'on retire des variables, m√™me si celles-ci ne
sont pas significatives. Toutefois, il est plus pertinent de se
concentrer sur le $R_a^2$ : celui-ci reste similaire entre le
sous-mod√®le (0.6612) et le mod√®le global (0.6633), ce qui valide notre
approche. Nous n'avons pas perdu vraiment d'information $67\  \%$ de la variance reste expliqu√©e par le mod√®le.

:::

:::

## Question 5 {#question-5}

Mettre en oeuvre une s√©lection automatique du meilleur sous-mod√®le possible du
"gros" mod√®le ajust√© dans la [question 2](#question-2), selon le crit√®re BIC. On pourra utiliser la
fonction  `regsubsets` de la libraire `leaps` (puis `plot.regsubsets`) ou `step`. Comparer
le mod√®le retenu avec le mod√®le choisi √† la question pr√©c√©dente.

::: {.content-visible when-meta="is_answer_print_5"}

::: answer

Pour rappel, le BIC est un crit√®re de s√©lection de mod√®le. En r√©gression
lin√©aire multiple, on a :

$$\textrm{BIC}=n \ln\left( \frac{S C R}{n}\right)+(p+1) \ln(n)$$

**Recherche exhaustive (√† privil√©gier quand le nombre de variable est
restreint)**

La fonction `regsubsets` du package `leaps` permet de calculer toutes
les combinaisons de mod√®le posible. Appliquer la fonction `plot` permet
ensuite de visualiser le r√©sultat.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
res_regsubset <- leaps::regsubsets(
  maxO3 ~ T9 + T12 + T15 + Ne9 + Ne12 + Ne15 + Vx9 + Vx12 + Vx15,
  data = data_ozone,
  nvmax = 9L
)
plot(res_regsubset)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
res_regsubset <- leaps::regsubsets(
  maxO3 ~ T9 + T12 + T15 + Ne9 + Ne12 + Ne15 + Vx9 + Vx12 + Vx15,
  data = data_ozone,
  nvmax = 9L
)
plot(res_regsubset)
```
:::

Cette sortie pr√©sente le meilleur mod√®le √† 1 variable, le meilleur
mod√®le √† 2 variables,... en les classant du pire (en bas) au meilleur
(en haut), selon le crit√®re BIC. Les variables s√©lectionn√©es dans chaque
mod√®le sont gris√©es. Si on se r√©f√®re √† cette s√©lection, on choisirait
donc le mod√®le avec les variables $\texttt{T12}$, $\texttt{Ne9}$ et $\texttt{Vx9}$ (ce choix est
donc diff√©rent du mod√®le que l‚Äôon avait retenu de fa√ßon naive ci-dessus)

**Recherche pas √† pas (√† privil√©gier quand il y a beaucoup de
variables)**

La fonction `step` permet de s√©lectionner un mod√®le pas √† pas. Il existe
plusieurs types (backward, forward, hybride). Contrairement √† la
proc√©dure exhaustive, les proc√©dures pas √† pas ne parcourent pas tous
les sous-mod√®les possibles. Ils peuvent donc √©ventuellement "rater" le
meilleur mod√®le.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
#BIC backward
cat("BIC backward\n")
step(
  object = modele_q2,
  k = log(nobs(modele_q2)),
  direction = "backward"
)

#BIC forward
cat("BIC forward\n")
step(
  object = lm(maxO3 ~ 1, data = data_ozone),
  scope = formula(modele_q2),
  k = log(nobs(modele_q2)),
  direction = "forward"
)

#BIC forward hybride
cat("BIC forward hybride\n")
step(
  object = lm(maxO3 ~ 1, data = data_ozone),
  scope = formula(modele_q2),
  k = log(nobs(modele_q2)),
  direction = "both"
)

#BIC backward hybride
cat("BIC backward hybride\n")
step(
  object = modele_q2,
  k = log(nobs(modele_q2)),
  direction = "both"
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
#BIC backward
cat("BIC backward\n")
step(
  object = modele_q2,
  k = log(nobs(modele_q2)),
  direction = "backward"
)

#BIC forward
cat("BIC forward\n")
step(
  object = lm(maxO3 ~ 1, data = data_ozone),
  scope = formula(modele_q2),
  k = log(nobs(modele_q2)),
  direction = "forward"
)

#BIC forward hybride
cat("BIC forward hybride\n")
step(
  object = lm(maxO3 ~ 1, data = data_ozone),
  scope = formula(modele_q2),
  k = log(nobs(modele_q2)),
  direction = "both"
)

#BIC backward hybride
cat("BIC backward hybride\n")
step(
  object = modele_q2,
  k = log(nobs(modele_q2)),
  direction = "both"
)
```
:::

Avec ces quatre m√©thodes pas √† pas sur le crit√®re BIC, on retrouve les
m√™mes r√©sultats que pr√©c√©demment avec la recherche exhaustive.

On retient le mod√®le :

$$\texttt{maxO3}_i = \beta_1+\beta_2\texttt{T12}_i+\beta_3\texttt{Ne9}_i+\beta_4\texttt{Vx9}_i+\varepsilon_i$$

:::

:::

## Question 6

Appliquer la s√©lection automatique pr√©c√©dente en vous basant sur d‚Äôautres crit√®res
que BIC. Les mod√®les retenus sont-ils les m√™mes ? Si non, lequel semble pr√©f√©rable ?

::: {.content-visible when-meta="is_answer_print_6"}

::: answer

Pour la m√©thode exhaustive, il est possible d'afficher le classement
selon d'autres crit√®res en ajustant l'option `scale`de la fonction
`regsubsets`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
plot(res_regsubset, scale = "adjr2")
plot(res_regsubset, scale = "Cp")
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
plot(res_regsubset, scale = "adjr2")
plot(res_regsubset, scale = "Cp")
```
:::

Le r√©sultat est identique avec les $R^2$ ajust√©s et les $C_p$ de Mallows
mais l'issue est diff√©rente par rapport √† la question pr√©c√©dente avec le
crit√®re BIC. On retiendrait aussi la variable $\texttt{T9}$. Comme elle
est tr√®s corr√©l√©e √† la variable $\texttt{T12}$, il semble raisonnable de
prendre plut√¥t le mod√®le obtenu √† la question 5, plus parcimonieux.

:::

:::

## Question 7

Analyser les r√©sidus du mod√®le s√©lectionn√© √† la question pr√©c√©dente par des repr√©sentations graphiques et en effectuant des tests d‚Äôhomosc√©dasticit√© et de non-corr√©lation des r√©sidus. Toutes les hypoth√®ses d‚Äôun mod√®le lin√©aire semblent-elles v√©rifi√©es ?

::: {.content-visible when-meta="is_answer_print_7"}

::: answer

**Analyse graphique des r√©sidus**

On analyse les r√©sidus graphiquement avec la fonction `plot`.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
modele_q5 <- lm(formula  = maxO3 ~T12 + Ne9 + Vx9, data = data_ozone) 
par(mfrow= c(2, 2))
plot(modele_q5)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q5 <- lm(formula  = maxO3 ~ T12 + Ne9 + Vx9, data = data_ozone)
par(mfrow= c(2, 2))
plot(modele_q5)
```
:::

Un examen graphique des r√©sidus r√©v√®le une distribution al√©atoire
satisfaisante car

-   aucune structure ni h√©t√©rosc√©dasticit√© n'est apparente (graphique en
    haut √† droite des r√©sidus et valeurs ajust√©es) ;
-   compatible avec une loi normale, bien que cela importe peu compte
    tenu du nombre d‚Äôobservations (graphique en haut √† droite - QQ plot)
    ;
-   aucun individu atypique n'est d√©tect√© (graphique en bas √† droite -
    distances de Cook)

**Test d‚Äôhomosc√©dasticit√© des r√©sidus**

::: callout-note
### Test de Breusch-Pagan

Le test de Breusch-Pagan permet de tester l‚Äôhomosc√©dasticit√©. Il
s'impl√©mente sous {{< iconify logos:r-lang >}} avec la fonction `bptest` de la librairie `lmtest`.

On suppose que $\varepsilon_i$ a une variance
$\sigma_i^2=\sigma^2+z_i'\gamma$

-   $z_i$ est un vecteur de $k$ variables √† choisir qui pourraient
    expliquer l'h√©t√©rosc√©dasticit√© (si elle est pr√©sente)
-   $\gamma$ est un param√®tre inconnu, de dimension $k$, √† estimer.

Par d√©faut sous {{< iconify logos:r-lang >}} : $z_i$ est simplement le vecteur des variables
explicatives $\left(X_i^{(1)}, \ldots, X_i^{(p)}\right)$, et donc $k=p$.
Mais on peut proposer autre chose.

Le test de Breusch-Pagan consiste √† tester

$$
H_0: \gamma=0 \quad \text { contre } \quad H_1: \gamma \neq 0 .
$$
:::

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
lmtest::bptest(modele_q5)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
lmtest::bptest(modele_q5)
```
:::

On ne rejette pas $H_0$ au seuil 5 %. L'homosc√©dasticit√© est v√©rifi√©e.

**Test de non-corr√©lation des r√©sidus**

::: callout-note
### Tests de Durbin-Watson et Breusch-Godfrey

Le tests de Durbin-Watson et Breusch-Godfrey permettent de tester la non
corr√©lation des r√©sidus. Ils s'impl√©mentent sous {{< iconify logos:r-lang >}} avec la fonction
`dwtest` et `bgtest` de la librairie `lmtest`.

On suppose que $\varepsilon_i$ sont auto-corr√©l√©es √† l'ordre $r$, i.e.

$$\varepsilon_i = \rho_1\varepsilon_{i-1}+\dots+\rho_r\varepsilon_{i-r}+\eta_i$$
o√π les $\eta_i$ sont $\texttt{iid}$ suivant une
$\mathcal{N}\left(0, \sigma^2\right)$.

**Test de Durbin-Watson** : il ne concerne que le cas $r=1$ et teste

$$
H_0: \rho_1=0 \quad \text { contre } \quad H_1: \rho_1 \neq 0 .
$$ **Test de Breusch-Godfrey** : il teste (diff√©remment),

$$
H_0: \rho_1= \dots = \rho_r = 0 \quad \text { contre } \quad H_1: \textrm{le contraire}
$$
:::

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
lmtest::dwtest(modele_q5)
lmtest::bgtest(modele_q5)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
lmtest::dwtest(modele_q5)
lmtest::bgtest(modele_q5)
```
:::

Dans les deux cas on rejette $H_0$ au seuil 5 %. Il semble donc exister
une auto-corr√©lation dans les r√©sidus, ce qui n‚Äôest pas surprenant
puisque la variable d‚Äôint√©r√™t, $\texttt{maxO3}$, est temporelle : la
valeur d'un jour donn√© est li√©e √† celle de la veille, et cela se
manifeste dans les r√©sidus du mod√®le. Cette observation indique que
l‚Äôhypoth√®se usuelle $\mathbb{V}(\varepsilon)=\sigma^2I_n$ n'est pas
respect√©e ici. Bien qu'on puisse voir cela comme une contrainte, c‚Äôest
en r√©alit√© une occasion d'am√©liorer le mod√®le initial : la corr√©lation
temporelle n'a pas √©t√© prise en compte, offrant ainsi un levier pour
enrichir notre mod√©lisation en int√©grant cette d√©pendance.

:::

:::

## Question 8

Afin de r√©soudre le probl√®me d‚Äôauto-corr√©lation des r√©sidus, on propose d‚Äôajouter la
maximum d‚Äôozone de la veille dans le mod√®le. Cr√©er cette variable, que l‚Äôon nommera
$\texttt{maxO3v}$ et ajouter-la au jeu de donn√©es. Observe-t-on un lien lin√©aire entre $\texttt{maxO3}$
et $\texttt{maxO3v}$ ?

::: {.content-visible when-meta="is_answer_print_8"}

::: answer

On peut cr√©er une variable retard $\texttt{maxO3v}$ correspondant au
maximum d'ozone de la veille.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
data_ozone_q8 <- data_ozone
data_ozone_q8$maxO3v <- c(NA, data_ozone$maxO3[1:(nrow(data_ozone)-1)])
plot(data_ozone_q8$maxO3v, data_ozone_q8$maxO3)
cor(data_ozone_q8$maxO3, data_ozone_q8$maxO3v, use='pairwise.complete.obs')
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
data_ozone_q8 <- data_ozone |>
  dplyr::mutate(
    maxO3v = dplyr::lag(maxO3)
  )
ggplot2::ggplot(
  data = data_ozone_q8,
  mapping = ggplot2::aes(x = maxO3, y = maxO3v)
) + geom_point()
cor(data_ozone_q8$maxO3, data_ozone_q8$maxO3v, use = 'pairwise.complete.obs')
```
:::

Le nuage de points et la corr√©lation lin√©aire confirment l'existence
d'un lien lin√©aire fort entre $\texttt{maxO3}$ et sa valeur de la
veille.

:::

:::

## Question 9

Ajuster le mod√®le de r√©gression contenant $\texttt{maxO3v}$ comme variable explicative suppl√©mentaire.
Analyser les r√©sultats de l‚Äôajustement : les hypoth√®ses d‚Äôun mod√®le
lin√©aire sont-elles v√©rifi√©es ?

::: {.content-visible when-meta="is_answer_print_9"}

::: answer

On ajoute la covariable $\texttt{maxO3v}$ au mod√®le de la question 5.

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
modele_q9 <- lm(formula  = maxO3 ~ T12 + Ne9 + Vx9 + maxO3v, data = data_ozone_q8)
summary(modele_q9)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
modele_q9 <- lm(formula  = maxO3 ~ T12 + Ne9 + Vx9 + maxO3v, data = data_ozone_q8)
summary(modele_q9)
```
:::

On constate que toutes les variables sont significatives. On effectue
l‚Äôanalyse des r√©sidus.

**Analyse graphique des r√©sidus**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
par(mfrow= c(2, 2))
plot(modele_q9)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
plot(modele_q9)
```
:::

Un examen graphique des r√©sidus r√©v√®le une distribution al√©atoire
satisfaisante car

-   aucune structure ni h√©t√©rosc√©dasticit√© n'est apparente (graphique en
    haut √† droite des r√©sidus et valeurs ajust√©es) ;
-   compatible avec une loi normale, bien que cela importe peu compte
    tenu du nombre d‚Äôobservations (graphique en haut √† droite - QQ plot)
    ;
-   aucun individu atypique n'est d√©tect√© (graphique en bas √† droite -
    distances de Cook)

**Test d‚Äôhomosc√©dasticit√© des r√©sidus**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
lmtest::bptest(modele_q5)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
lmtest::bptest(modele_q9)
```
:::

On ne rejette pas $H_0$ au seuil 5 %. L'homosc√©dasticit√© est confirm√©e.

**Test de non-corr√©lation des r√©sidus**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
lmtest::dwtest(modele_q9)
lmtest::bgtest(modele_q9)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
lmtest::dwtest(modele_q9)
lmtest::bgtest(modele_q9)
```
:::

On ne rejette pas $H_0$ au seuil 5 % dans les deux cas. L'absence
d'autocorr√©lation est confirm√©e.

:::

:::

## Question 10

Comparer ce dernier mod√®le au mod√®le sans $\texttt{maxO3v}$ √† l‚Äôaide d‚Äôun test de Fisher et en comparant les diff√©rents crit√®res de s√©lection (AIC, BIC, Cp de Mallows, R¬≤ ajust√©).

::: {.content-visible when-meta="is_answer_print_10"}

::: answer

**Test de Fisher sur des mod√®les emboit√©s**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
car::linearHypothesis(
  modele_q9,
  matrix(c(0, 0, 0, 0, 1), nrow = 1, byrow = TRUE)
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
car::linearHypothesis(
  modele_q9,
  matrix(c(0, 0, 0, 0, 1), nrow = 1, byrow = TRUE)
)
```
:::

Le test de Fisher sur les mod√®le emboit√© confirme la significativit√© de
la variable $\texttt{maxO3v}$.

**Crit√®res de s√©lection**

::: {.panel-tabset group="language"}
### Base R

```{webr}
#| envir: tdv
#| autorun: true
cp_mallows <- function(lm_model, lm_full) {
  # Nombre d'observations
  n <- length(residuals(lm_model))
  
  # Nombre de param√®tres (y compris l'intercept)
  p <- length(coef(lm_model))
  
  # Somme des carr√©s des r√©sidus
  RSS <- sum(residuals(lm_model)**2)
  
  # Estimation de la variance des erreurs √† partir du mod√®le complet
  sigma_hat2 <- summary(lm_full)$sigma**2
  
  # Calcul de Cp de Mallows
  Cp <- RSS / sigma_hat2 - (n - 2 * p)
  
  return(Cp)
}
modele_full <- lm(
  maxO3 ~ T9 + T12 + T15 + Ne9 + Ne12 + Ne15 + Vx9 + Vx12 + Vx15 + maxO3v,
  data = data_ozone_q8
)
data.frame(
  `Crit√®re` = c("AIC", "BIC", "Cp de Mallows", "R¬≤-adj"),
  `Mod√®le Q5` = c(
    AIC(modele_q5),
    BIC(modele_q5),
    cp_mallows(modele_q5,modele_full),
    summary(modele_q5)$adj.r.squared
  ),
  `Mod√®le Q9` = c(
    AIC(modele_q9),
    BIC(modele_q9),
    cp_mallows(modele_q9, modele_full),
    summary(modele_q9)$adj.r.squared
  )
)
```

### Tidyverse

```{webr}
#| envir: tdv
#| autorun: true
cp_mallows <- function(lm_model, lm_full) {
  # Nombre d'observations
  n <- length(residuals(lm_model))
  
  # Nombre de param√®tres (y compris l'intercept)
  p <- length(coef(lm_model))
  
  # Somme des carr√©s des r√©sidus
  RSS <- sum(residuals(lm_model)**2)
  
  # Estimation de la variance des erreurs √† partir du mod√®le complet
  sigma_hat2 <- summary(lm_full)$sigma**2
  
  # Calcul de Cp de Mallows
  Cp <- RSS / sigma_hat2 - (n - 2 * p)
  
  return(Cp)
}
modele_full <- lm(
  maxO3 ~ T9 + T12 + T15 + Ne9 + Ne12 + Ne15 + Vx9 + Vx12 + Vx15 + maxO3v,
  data = data_ozone_q8
)
tibble::tibble(
  `Crit√®re` = c("AIC", "BIC", "Cp de Mallows", "R¬≤-adj"),
  `Mod√®le Q5` = c(
    AIC(modele_q5),
    BIC(modele_q5),
    cp_mallows(modele_q5,modele_full),
    summary(modele_q5)$adj.r.squared
  ),
  `Mod√®le Q9` = c(
    AIC(modele_q9),
    BIC(modele_q9),
    cp_mallows(modele_q9, modele_full),
    summary(modele_q9)$adj.r.squared
  )
)
```
:::

Quel que soit le crit√®re le mod√®le avec l‚Äôintroduction de la variable
$\texttt{maxO3v}$ est meilleur.

:::

:::
